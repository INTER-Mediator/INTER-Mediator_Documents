<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" class="hltr"><head><title>データベースへのクエリーと一覧表示</title><link href="00_default.css" rel="stylesheet" media="all"/></head><body xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:msyk="http://msyk.net/Editorial" xmlns:aid5="http://ns.adobe.com/AdobeInDesign/5.0/" xmlns:aid="http://ns.adobe.com/AdobeInDesign/4.0/"><div id="main"><h1><span id="H1-ANC-1"><span style="display:none">→</span></span><span class="chapternumber">Chapter 2</span><br/>データベースへのクエリーと一覧表示</h1><p class="version-notation">この章は、INTER-Mediator Ver.10をもとに記載しました。</p><p class="chapter-lead">まず最初にシンプルなページを作りながら、設定した内容がどのように機能するのかを少しずつ見ていくことにしましょう。この章と次の章は、主に、データベースにあるデータをWebページの上に展開するための設定を見ていきます。また、演習環境の利用方法を詳しく説明しますので、次の章以降は、VMの使用方法についてはあまり触れません。この章の中で十分に理解してから次に進むようにしてください。</p><!-- ============ SECTION START ============ --><h2><span id="H2-ANC-1"><span style="display:none">→</span></span><span class="sectionnumber">2-1</span><span xmlns="" id="ix-1"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-2"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>データベースからの取り出し設定</h2><p class="section-lead">データベースからのクエリ（あるいは読み出し）の処理は、データベースを利用する基本でもあります。加えて、単に読み出し結果をブラウザー上に表示するだけでなく、見やすく表示させるということも重要です。レイアウトを厳密に構成できることがHTMLの特徴ですから、データベースの内容をきれいに構成してWebブラウザーで表示させることが可能になります。最初に、さまざまな設定のための基本について解説します。</p><h3><span id="H3-ANC-1"><span style="display:none">→</span></span>INTER-Mediatorとデータベース</h3><p>　INTER-Mediatorは、<span xmlns="" id="ix-3"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>データベースを利用したWebアプリケーション開発のためのフレームワークです。INTER-Mediatorとデータベースは別々の存在として、インストール等されている必要があります。また、INTER-Mediatorでのアプリケーションを作る上では、データベース上にアプリケーションの稼働が可能な<span xmlns="" id="ix-4"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>テーブル設計等（一般には「<span xmlns="" id="ix-5"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>スキーマ設計とその適用」）が完了している必要があります。テーブルの作成など、データベース側の運用を直接サポートする機能は現在のVer.10のINTER-Mediatorには含まれていません。</p><p>　<span xmlns="" id="ix-6"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-7"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>利用可能なデータベースは大きく分けて2種類があります。PHP言語でのデータベース抽象化レイヤーのひとつである「<span xmlns="" id="ix-8"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>PDO（<span xmlns="" id="ix-9"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>PHP Data Objects）」を利用する方法と、<span xmlns="" id="ix-10"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>FileMaker Serverを利用する方法です。PDOでは、さらにデータベースエンジンごとにドライバーが内部で用意されていますが、Ver.10現在、<span xmlns="" id="ix-11"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>MySQL、<span xmlns="" id="ix-12"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>PostgreSQL、<span xmlns="" id="ix-13"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>SQLite、<span xmlns="" id="ix-14"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>SQL Serverの4つのデータベースをサポートしています。そして、SQL Serverを除く3つのデータベースエンジに関して、開発時にテストケースを適用して確認をしています。PDOがサポートするその他のデータベースエンジン（例えば、Oracleなど）は、理論上は利用可能ですが、開発側でテストを実施していないために実際にサンプル等での動作保証はできません。原則、いずれもSQLデータベースである点での違いは薄いのですが、細かな点での記述方法の違いなどもあり、INTER-Mediatorで提供された素材そのままで運用することを誰も確認していない状況と考えてください。</p><p>　FileMaker Serverについては、XML共有を利用する方法と、FileMaker Data APIを利用する方法をサポートしています。XML共有を使うために、FX.phpというライブラリを利用します。そのため、XML共有を使う場合はかなり古いFileMaker Serverであっても稼働はします。FileMaker Data APIを使う場合はVer.18以降のFileMaker Serverを利用するようにしてください。それ以前のData APIは使えなくはないのですが、ライブラリのFMDataAPIのバージョンを古くするなどの対処が必要になります。</p><p>　なお、本コースでは、原則として、演習環境で動作するMySQLを利用して演習を進め、データベースエンジンごとに違いがある部分については、その都度説明をします。実際にデータベースを利用して開発をされた方はご存知の通り、同じSQLデータベースでも、けっこう違いが大きいものです。INTER-Mediatorでのデータベースの扱いとしては、ひとつの考え方として、「INTER-Mediatorが必要なSQLステートメントを生成してデータベースに投げる」というイメージを考えてください。そのため、INTER-Mediator側の作業に入ると、データベースは完全に抽象化されて、データベースごとの違いを意識せずとも使えるようになっています。概念的に同じ特性を持つデータベースとして考えて差し支えないものになっています。INTER-Mediatorがデータベースエンジンの間の細かな違いを吸収していると考えてけっこうです。特に、基本的にSQLデータベースではないFileMakerとMySQLを、同じような手法で利用できるようになっています。</p><h3><span id="H3-ANC-2"><span style="display:none">→</span></span>PDOでの接続に必要な情報</h3><p>　MySQLを始めとするPDOを利用した<span xmlns="" id="ix-15"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>接続で必要になる情報は、必要な設定を行う前に確認しておく必要があります。MySQLとPostgreSQLについては、ソケット経由での接続と、TCP/IPのポートに対して接続する方法があります。データベースとWebサーバーが同一のホストの場合、どちらでも利用できます。異なるホストの場合は、ポート接続を行います。SQLiteについては、ファイルを直接読み書きしているので、同一のホストである必要があります。</p><p>　いずれのデータベースについても、データベースエンジン自体の指定だけでなく、「<span xmlns="" id="ix-16"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>データベース名」の指定が必要になります。一般に、データベースエンジンは、データベースを運用するソフトウェアを示す用語ですが、ひとつのデータベースエンジンは、同時に複数のデータベースを運用することが可能です。SQLデータベースでは、ひとつのデータベースの中に、複数のテーブルやビューといったエンティティを定義でき、テーブルには複数のフィールドが定義されていて、データの記録ができるようになっています。</p><p>　INTER-MediatorでPDOを利用する場合、合計5つの設定項目を確定させる必要があります。これらの実際の設定方法は、この後に、演習の中で行うことにします。コロン（：）の左側が設定の種類を示すキーワードで、右側はその設定値です。キーワードはINTER-Mediatorで決められたものですが、値は状況により変わります。PDOを使う場合には、<span xmlns="" id="ix-17"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>db-classに対する値は「PDO」で一定です。dsnは、データベースに接続するためのさまざまな情報をひとまとめにしたもので、すぐ後に説明します。<span xmlns="" id="ix-18"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>userと<span xmlns="" id="ix-19"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>passwordは、データベースを利用するために必要なアカウントの情報で、データベースのセットアップ時に指定しているものです。<span xmlns="" id="ix-20"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>optionsには、一般には設定はなにもしなくてもかまいません。</p><div class="code"><div class="caption">リスト2-1-1　MySQLを利用する場合のデータベース設定</div><pre><code>（ソケットを利用する接続の場合）
db-class：PDO
dsn：mysql:unix_socket=/var/run/mysqld/mysqld.sock;dbname=test_db;charset=utf8mb4
user：web
password：password
options：（設定不要）

（ホスト名を指定する接続の場合）
dsn：mysql:host=localhost;dbname=test_db;charset=utf8mb4
</code></pre></div><p>　<span xmlns="" id="ix-21"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>dsnについて説明をします。dsnは、半角のセミコロン（；）で区切った文字列で、それぞれは「キーワード=値」の形式のデータが含まれたものです。dsnは<span xmlns="" id="ix-22"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>Data Source Nameの略ですが、単に名前だけでなく、さまざまな情報を指定します。最初の「<span xmlns="" id="ix-23"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>mysql」は、データベースエンジンの種類であり、MySQLの場合は常に「mysql」です。</p><p>　<span xmlns="" id="ix-24"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ソケットを使う場合には、「<span xmlns="" id="ix-25"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>unix_socket=パス」の形式で記述します。パスは、セットアップの方法やあるいは設定ファイルの書き方で変わってきます。TCP/IPのポートに接続する場合には、「<span xmlns="" id="ix-26"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>host=ホスト名」によってデータベースエンジンが稼働しているホストのIPアドレスやホスト名、FQDN等を指定します。通常は、MySQLはポート番号3306で稼働していますが、既定のポート番号の場合はポート番号の指定は不要です。サーバーの設定により異なるポートで運用している場合には「<span xmlns="" id="ix-27"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>port=ポート番号」の記述も追加します。unix_socketとhostの指定は両立せず、どちからのみを指定するのが原則です。</p><p>　接続先のデータベースは「<span xmlns="" id="ix-28"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>dbname=データベース名」で指定します。データベース名は、実際に使うデータベース名に変更します。本コースでは、サンプルアプリケーションを稼働するためのデータベース「test_db」をそのまま利用しますので、常に「dbname=test_db」で利用します。</p><p>　データベースで利用する<span xmlns="" id="ix-29"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>文字セットを「<span xmlns="" id="ix-30"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>charset=文字セット名」で記述します。MySQLの場合は、このdsnの設定に文字セットを可能な限り設定することをお勧めします。一般には、文字セット名は「utf8」でかまいませんが、絵文字や一部の漢字にあるような4バイトのUnicode文字もサポートするために「<span xmlns="" id="ix-31"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>utf8mb4」という文字セットをMySQL Ver.5.5.3以降でサポートする記述を利用します。これ以前のMySQLでは、utf8しか使えません。4バイトの文字というのは、32ビットコードという意味ではなく、UTF-8での文字表現で4バイトを使用する文字ということです。従来からよく利用されてきた一般的な文字列の多くは日本語の場合UTF-8では3バイトになります。しかしながら、「𥔎」という文字は、Unicodeでは、U+2550Eというコードが割り当てられており、UTF-8でエンコードした場合、F0 A5 94 8Eという4バイトでの表現となります。OSがサポートする文字種が増えているだけに、可能な限りutf8mb4で運用する方が望ましいと言えます。</p><p>　MySQLとの接続に必要なアカウントの作成と、アクセス権の設定は、例えばリスト2-1-2のように行います。このユーザー「web」はlocalhost経由での接続が許されており、さらに<span xmlns="" id="ix-32"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>GRANTステートメントで指定されたステートメントの実行のみが、データベースtest_dbに対して定義されています。</p><div class="code"><div class="caption">リスト2-1-2　MySQLでユーザーに対してデータ処理権限を与える</div><pre><code><span xmlns="" id="ix-33"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>CREATE USER 'web'@'localhost' <span xmlns="" id="ix-34"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IDENTIFIED BY 'password';
GRANT SELECT, INSERT, DELETE, UPDATE ON TABLE test_db.* TO 'web'@'localhost';</code></pre></div><p>　<span xmlns="" id="ix-35"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>PostgreSQLを利用する場合の設定はリスト2-1-3の通りです。MySQLと原則同一ですが、データベースエンジンが違うので、dsnの書き方が異なり、「<span xmlns="" id="ix-36"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>pgsql」で始めます。userとpasswordは、データベース側に定義した利用可能なアカウントを指定します。文字セットの指定は、INTER-Mediator側の指定では行わないでも一般には大丈夫です。データベースの設定でエンコード指定が行われているのが一般的です。なお、PHPのマニュアルによると、PDOを利用したPostgreSQL利用時にソケット接続するためには、dsnを「pgsql:user=web dbname=test_db password=password」のように記述すれば良いとなっていますが、INTER-Mediatorでは利用しているAPIの都合上、Ver.10現在、この方法での接続はできません。hostを利用して接続先を指定してください。</p><div class="code"><div class="caption">リスト2-1-3　PostgreSQLを利用する場合のデータベース設定</div><pre><code>db-class：PDO
dsn：pgsql:host=localhost;port=5432;dbname=test_db
user：web
password：password
options：（設定不要）</code></pre></div><div class="code"><div class="caption">リスト2-1-4　PostgreSQLでのユーザー定義とアクセス権設定の例</div><pre><code>CREATE USER web PASSWORD 'password';
GRANT ALL PRIVILEGES ON SCHEMA im_sample TO web;
GRANT ALL PRIVILEGES ON im_sample.person TO web;
GRANT ALL PRIVILEGES ON im_sample.postalcode TO web;
		:</code></pre></div><p>　<span xmlns="" id="ix-37"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>SQLiteを利用する場合、データベース自体はファイルとして提供され、ドライバーがそのファイルに直接的にやりとりすることになります。リスト2-1-5に設定をまとめますが、ファイルアクセスということが原則のため、データベース自体にアカウントの仕組みはなく、userとpasswordは指定する必要がありません。dsnには、SQLiteを使用することを示す「<span xmlns="" id="ix-38"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>sqlite:」の文字列と、それに続いて<span xmlns="" id="ix-39"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-40"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>データベースファイルの絶対パスを記述します。設定はこれだけです。エンコードについても、SQLite Ver.3ではデータベース自体がUTF-8を前提としているため、特に指定する必要はありません。</p><div class="code"><div class="caption">リスト2-1-5　SQLiteを利用する場合のデータベース設定</div><pre><code>db-class：PDO
dsn：sqlite:/var/db/im/sample.sq3
user：（設定不要）
password：（設定不要）
options：（設定不要）</code></pre></div><p>　SQL Serverでのデータベース設定はdsnはシンプルにserverキーでホストを指定し、databaseキーでデータベース名を指定するだけで可能です。また、GRANTも現在のデータベース内のオブジェクトにまとめて設定することができるので、シンプルな記述で可能です。</p><div class="code"><div class="caption">リスト2-1-6　SQL Serverを利用する場合のデータベース設定</div><pre><code>db-class：PDO
dsn：sqlsrv:server=localhost;database=test_db
user：web
password：password
options：（設定不要）</code></pre></div><div class="code"><div class="caption">リスト2-1-7　SQL Serverでのアクセス権の設定例</div><pre><code>CREATE DATABASE test_db COLLATE Japanese_CI_AI;
USE test_db;
CREATE LOGIN web WITH PASSWORD='password', CHECK_POLICY=OFF;
CREATE USER web;
GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE TO web;
GO</code></pre></div><h3><span id="H3-ANC-3"><span style="display:none">→</span></span><span xmlns="" id="ix-41"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-42"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>FileMaker Serverへの接続</h3><p>　FileMaker Serverは、<span xmlns="" id="ix-43"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>Web公開エンジンの設定をしておく必要があります。単にサーバーをインストールするだけではなく、Web共有可能にセットアップしなければなりません。また、<span xmlns="" id="ix-44"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>WebDirectについては、有効にしておく必要はありません。もちろん、INTER-Mediatorとは別にWebDirectを利用するのであれば、オンにしておきます。</p><div class="picture"><img class="picture-small" src="figs/ng-shot-019.png"/><div class="caption">図2-1-1　FileMaker Serverの管理コンソールでWeb公開エンジンを有効にする</div></div><p>　FileMaker Data APIを利用する場合は、やはりFileMaker Serverの管理コンソールで、FileMaker Data APIを有効にしておく必要があります。</p><div class="picture"><img class="picture-small" src="figs/ng-shot-020.png"/><div class="caption">図2-1-2　FileMaker Serverの管理コンソールでFileMaker Data APIを有効にする</div></div><p>　一方、XML共有を利用する場合は、FileMaker Serverをセットアップした後、そのコンピュータ上で以下のようにコマンドを入力する必要があります。これらのコマンドによって、<span xmlns="" id="ix-45"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>XML共有と<span xmlns="" id="ix-46"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>PHP共有が有効になります。を有効にしておく必要があります。コマンド入力後、FileMaker Serverの管理コンソールにログイン可能なユーザ名とそのパスワードを指定する必要があります。</p><div class="code"><div class="caption">リスト2-1-8　SQL Serverでのアクセス権の設定例</div><pre><code>fmsadmin set cwpconfig enablexml=true
fmsadmin set cwpconfig enablephp=true</code></pre></div><p>　PHPの稼働についても、バージョンごとに方法が異なり、現在最新のVer.19.4ではPHPはFileMaker Serverとは別にセットアップが必要になっています。なお、本コースの購入者の方々に対しては、FileMaker Serverそのもののサポートも行いますので、うまく稼働ができない場合には、筆者まで連絡を取ってください。</p><p>　FileMaker Serverで公開するデータベースについては、XML共有もしくはData APIからのアクセスができるようにしておく必要があります。「ファイル」メニューの「管理」の「セキュリティ」を選択して、初期状態にあるadmin以外に、新たにユーザーを作成するのが良いでしょう。また、ゲストでの運用も可能な限り行わない方が良いでしょう。ここでは、webという名前のユーザーを選択しています。そして、このユーザーはデータの入出力ができればいいので、最大でも「データ入力のみ」のアクセス権セットを選択しておきます。可能であれば、より権限の狭いアクセス権セットにする方が好ましいでしょう。</p><div class="picture"><img class="picture-small" src="figs/ng-shot-021.png"/><div class="caption">図2-1-3　INTER-Mediatorから利用する専用のユーザーを定義する</div></div><p>　そして、INTER-Mediatorから利用するユーザーの<span xmlns="" id="ix-47"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>アクセス権セットについては、FileMaker Pro上で拡張アクセス権の設定を行います。XML共有を使う場合には、「<span xmlns="" id="ix-48"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>XML Web共有でのアクセス - FMSのみ (fmxml)」および「<span xmlns="" id="ix-49"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>PHP Web共有でのアクセス - FMSのみ (fmphp)」の拡張アクセス権を設定します。Data APIを使用する場合には、「<span xmlns="" id="ix-50"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>FileMaker Data APIでのアクセス - FMSのみ (fmrest)」のチェックをオンにします。このように、アクセス権の設定が変わるので、「データ入力のみ」のアクセス権セットを既定値のまま保持したい場合は、このアクセス権セットを複製して、複製した方のセットをINTER-Mediatorから利用するユーザーに割り当ています。さらに、このデータベースをFileMaker Proから開くには、「<span xmlns="" id="ix-51"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>FileMakerネットワークによるアクセス (fmapp)」もチェックを入れます。INTER-Mediatorに付属しているTestDB.fmp12では、adminユーザーにのみ「FileMakerネットワークによるアクセス」のチェックを入れてあります。</p><div class="picture"><img class="picture-small" src="figs/ng-shot-022.png"/><div class="caption">図2-1-4　データベースのユーザーに対して拡張アクセス権を許可する</div></div><p>　FileMaker Serverおよびデータベースに関して以上の準備をすれば、INTER-Mediator側の設定を決めることができます。FIleMakerデータベースについては、リスト2-1-9のような項目を設定します。設定項目は多くなりますが、FileMaker ServerのXML共有あるいはData APIを利用するための設定を基本的にすべて設定可能にしているためです。それぞれの場合の設定例を示します。</p><div class="code"><div class="caption">リスト2-1-9　FileMaker Serverを利用する場合のデータベース設定</div><pre><code>db-class：FileMaker_FX
<span xmlns="" id="ix-52"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>database：TestDB
user：web
password：password
<span xmlns="" id="ix-53"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>server：192.168.56.1
port：80
<span xmlns="" id="ix-54"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>protocol：http
<span xmlns="" id="ix-55"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>datatype：FMPro12

db-class：FileMaker_DataAPI
database：TestDB
user：web
password：password
server：localhost
port：443
protocol：https
cert-verifying：true</code></pre></div><p>　db-classは、INTER-MediatorにFileMaker Server用の機能を利用するように指定する部分と考えてください。XML共有を使う場合には、FileMaker_FX、DataAPIを使う場合にはFileMaker_DataAPIを指定します。databaseは、FileMaker Serverで公開されているデータベースのファイル名を指定します。拡張子はあってもなくてもかまいません。userとpasswordは、FileMakerのデータベースに定義した、データの読み書き可能なアカウントのものを指定します。serverは、FileMaker Serverが稼働しているホストのIPアドレスや、あるいはホスト名を指定します。同一のサーバーであればlocalhostや127.0.0.1を指定します。portは、FileMaker Serverの設定に依存しますが、一般には80ないしは443になると思われます。そして、protocolもFileMaker Serverの設定に依存しますが、一般にはhttpあるいはhttpsになると思われます。FileMaker Data APIについては、原則としてhttpsで443ポートにする必要があります。datatypeはXML共有の場合にのみ必要で、サーバーのバージョンに応じたものを指定するような雰囲気もあるかもしれませんが、FMPro12以降は特に動作に違いはありませんので、あまり気にすることはありません。「FMPro12」等を設定しておけば当面は問題ないと思われます。cert-verifyingはData APIの時に必要で、FileMaker Serverへの接続において、httpsの証明書の検証を行うかどうかです。既定値はtrueで行うようになっていますが、その場合serverがlocalhostだった場合に証明書のセットアップが事実上できないことになります。そこで、cert-verifyingをfalseにすることで、証明書は使うが検証はしない状態にできます。この場合、証明書はFileMaker Serverがセットアップ時に用意したものになっている可能性もあります。要するに、暗号化は行うけどサーバのホスト名の検証が省略されるということです。原則として、テスト運用等での利用にとどめてください。</p><h3><span id="H3-ANC-4"><span style="display:none">→</span></span>このセクションのまとめ</h3><p>　このセクションでは、INTER-Mediatorで使用するデータベースに関して、INTER-Mediatorに設定する情報にどのようなものがあるかを紹介しました。ここで集めた情報を実際に設定する方法は、この後引き続いて説明を行います。</p><!-- ============ SECTION START ============ --><h2><span id="H2-ANC-2"><span style="display:none">→</span></span><span class="sectionnumber">2-2</span>ページ構築のための基本設定</h2><p>　サンプルデータベースにある郵便番号のテーブルからその一覧を表示するWebページを作成します。フィールドの値をページ上に表示させることや、複数のレコードが取得された場合の繰り返し処理を説明します。ここでは、さまざまな設定をひとつひとつ追っていくことにします。</p><h3><span id="H3-ANC-5"><span style="display:none">→</span></span><span xmlns="" id="ix-56"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-57"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>Webページの基本構成</h3><p>　INTER-Mediatorで作成するWebページは、最終的にはブラウザーでアクセスした結果、データベースの内容が表示されたり、あるいはデータベースへの入力や編集ができるようになっている必要があります。そうした働きの全体像を示したのが図2-2-1です。Webアプリケーションとして共通の処理をフレームワークとして提供し、用途によって異なる部分をその都度開発するというの基本です。まず、開発に先立って、スキーマが適用されたデータベースがあることが前提です。これら以外に、HTMLで記述する「<span xmlns="" id="ix-58"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ページファイル」と、PHPで記述する「<span xmlns="" id="ix-59"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>定義ファイル」を用意します。</p><div class="picture"><img class="picture-small" src="figs/ng-fig01.png" altsrc="figs/ng-fig01.pdf"/><div class="caption">図2-2-1　INTER-Mediatorと開発物の構成</div></div><p>　ページファイルは、実際にブラウザーが解釈してレイアウトされたページとしてレンダリング可能なHTMLであり、最終的なページを構成するためのテンプレート、つまり、データを埋め込む前の状態を記述したものと考えてください。例えば、データベースの内容を表にしたいのなら、TABLE、TR、TDといったタグで、1レコード分の表示をどのようにするのかをHTMLで記述するのが典型的な例です。</p><p>　一方、定義ファイルには、データベースの接続に関する設定を始めとして、さまざまな動作の設定を記述します。ページファイルにすべてを記述しない理由のひとつは、ある種の設定の共通化を行う場合を想定しているからです。例えば、ひとつの定義ファイルを複数のページファイルで利用するといった状況です。さらに、HTMLのタグは設定が多くなると可読性が落ちます。そのため、ページファイルには定義ファイルのどの設定を使うのかを記述するというのが基本的な考え方になります。また、後で説明するように、データベースにあるデータを単にテーブルとして扱うのではなく、「<span xmlns="" id="ix-60"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>コンテキスト」として、抽象化された対象として取り扱うことが動作の基礎をなしており、定義ファイルはコンテキストを定義するファイルとして存在しています。</p><p>　図2-2-1では、フレームワークが提供する部分と、さらにフレームワークの動作を拡張したり、間に入って処理系の違いを仲介するデータコンバーターなどの拡張を示す部分についても記載があります。これらの拡張コンポーネントについては、コースの後半に解説を行います。ここよりいくつかの章は、ページファイルや定義ファイルを作成することで実現する範囲の機能を説明します。</p><p>　実際に稼働させると、ページファイルとフレームワークの一部がブラウザーにダウンロードされて、ページの生成を始めます。その途中で必要に応じてデータベース処理を行います。</p><h3><span id="H3-ANC-6"><span style="display:none">→</span></span>定義ファイルに定義するコンテキスト</h3><p>　実際のファイルの記述方法を説明する前に、まず、「<span xmlns="" id="ix-61"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>コンテキスト」の概念を説明しましょう。図2-2-2は、コンテキストを中心とした、INTER-MediatorによるWebページの構成です。データベースのデータをそのままページに持ち込むではなく、コンテキストという中間的なものを定義します。コンテキストの実体、すなわち、コンテキストから得られるデータは、<span xmlns="" id="ix-62"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-63"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>テーブル形式のデータ（つまり、「<span xmlns="" id="ix-64"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>リレーション」）と考えてください。</p><div class="picture"><img class="picture-small" src="figs/ng-fig02.png" altsrc="figs/ng-fig02.pdf"/><div class="caption">図2-2-2　コンテキストの概念</div></div><p>　このコンテキストは、テーブルと同一ではなく、意味が付加されたテーブル形式のデータです。ここでの意味というのは、具体的には検索条件や並べ替えフィールドの指定、そしてそれらの条件を適用した結果、得られたテーブル形式のデータを示すものです。つまり、成り立ちに意味があるデータです。例えば、住所録のテーブルがあるとします。その中で、利用者が興味があるのは、「学校の同期生」「家族と親戚」「取引先関係」など、その一部のデータであり、一部を抽出するためには意味をきちんと定義しなければなりません。住所録に対してなんらかの意味を与えることによって、得られるデータをコンテキストとします。もちろん、適切なフィールドの定義や、きちんとしたデータの入力など、さまざまな条件を満たさないと、コンテキストは完成しませんが、テーブルそのものではなく、意味を付与したコンテキストを中心にして、Webページを構成するという手法をINTER-Mediatorでは採用しています。</p><p>　そして、ページファイルの一部分が、コンテキストに対応付けられます。その規則についてはこの後すぐに説明をします。実際にブラウザー上で構成されるHTMLは、テンプレートとしてのページファイルの内容と、コンテキストで得られるデータを合成したものです。</p><h3><span id="H3-ANC-7"><span style="display:none">→</span></span><span xmlns="" id="ix-65"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-66"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>定義ファイルの記述方法</h3><p>　定義ファイルはPHPで記述します。PHPの文法を駆使したプログラムを記述するのではなく、主として、キーと値のセット（連想配列）による、コンテキストの定義やデータベースの接続のための設定などを記述します。したがって、プログラムを作成する知識は必要ではありませんが、一方でPHPのルールに従った連想配列を記述する必要があるため、基本文法についてはある程度知っていると作業はスムーズでしょう。リスト2-2-1は定義ファイルの記述例です。</p><div class="code"><div class="caption">リスト2-2-1　定義ファイルの記述例</div><pre><code>&lt;?php
require_once('INTER-Mediator/INTER-Mediator.php');

IM_Entry(
    // ここから第1引数
    array(
        array(
            'name' =&gt; 'postalcode', 'table' =&gt; 'postalcode', 'view' =&gt; 'postalcode',
            'records' =&gt; 10, 'maxrecords' =&gt; 100,
            'paging' =&gt; true, 'key' =&gt; 'id',
            'query' =&gt; array(
                array( 'field' =&gt; 'f3', 'value' =&gt; '1%', 'operator' =&gt; 'LIKE' )
            ),
            'sort' =&gt; array(
                array( 'field' =&gt; 'f3', 'direction' =&gt; 'ASC' )
            ),
            'repeat-control' =&gt; 'confirm-insert confirm-delete',
        ),
    ),
    // ここから第2引数
    array(
    ),
    // ここから第3引数
    array( 'db-class' =&gt; 'PDO', 'dsn' =&gt; 'mysql:host=localhost;charset=utf8mb4', 
             'user' =&gt; 'web', password =&gt; 'password' ),
    // ここから第4引数
    2
);</code></pre></div><p>　定義ファイルは拡張子が.phpのファイルに保存します。そして、中身はPHP言語なので、冒頭には「&lt;?php」の記述があります。続くrequire_onceにより、INTER-Mediatorの本体を読み込みます。サーバーのファイルシステム上で、この定義ファイルと、INTER-MediatorフォルダーにあるINTER-Mediator.phpファイルとの間の相対パスを記述します。この例の場合は定義ファイルと同じフォルダーにINTER-Mediatorフォルダーがあるので、指定のようなパスになります。そして、定義ファイルの残りの部分は、<span xmlns="" id="ix-67"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IM_Entry関数の呼び出しです。この関数の呼び出しを行うことは常に決まっています。引数は表2-2-1に示します。連想配列のキーに相当する文字列はすでに決められたものとなっており、決められていないキーは、デバッグ時にはエラーを出すようにしています。キーに指定する文字列とその機能は、本コースで順次説明します。</p><div class="table"><table><tr><th>引数</th><th>設定する値</th><th>解釈される内容</th></tr><tr><td>1</td><td><span xmlns="" id="ix-68"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>コンテキスト定義の配列</td><td>コンテキスト定義は連想配列で記述する</td></tr><tr><td>2</td><td><span xmlns="" id="ix-69"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>オプション設定の配列</td><td>コンテキスト外部に設定する内容</td></tr><tr><td>3</td><td><span xmlns="" id="ix-70"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>データベース接続の配列</td><td>データベース接続に必要な情報</td></tr><tr><td>4</td><td><span xmlns="" id="ix-71"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>デバッグ情報</td><td>falseならデバッグしない、2ならデバッグ情報をページ上に表示する</td></tr></table><div class="caption">表2-2-1　IM_Entry関数の引数</div></div><p>　もし、PHPのプログラムのファイルを直接開いて編集したくない場合には、INTER-Mediator内に組み込みの「<span xmlns="" id="ix-72"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>定義ファイルエディター（Definition File Editor）」も用意していますので、こちらをお使いください。INTER-Mediator-Server VMでは簡単に定義ファイルを利用できるようになっています。このエディターは、Webアプリケーションの形式になっており、ブラウザーでデータを入力して保存できるようになっています。INTER-Mediator-Server VM上では、各ファイルやディレクトリに適切なアクセス権が設定されているので保存が可能ですが、Webブラウザーの稼働ユーザーの権限で、定義ファイル自体に書き込みが可能になっていないと、書き込み時にエラーが出ます。その場合はファイルのアクセス権を改めて調べてみてください。</p><div class="picture"><img class="picture-small" src="figs/ng-shot-008.png"/><div class="caption">図2-2-3　Webアプリケーションとして稼働する定義ファイルエディター</div></div><p>　この後の演習で、実際に、ファイルの内容を編集する方法も含めて、作業手順を示しながら、作成方法を学習します。</p><h3><span id="H3-ANC-8"><span style="display:none">→</span></span><span xmlns="" id="ix-73"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-74"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ページファイルの記述方法</h3><p>　ページファイルは、拡張子が.htmlで、HTMLで記述するWebページのテンプレートとなるファイルです。まず、ヘッダーセクションでは、定義ファイルを、SCRIPTタグで読み込みます。定義ファイルはPHPで記述されたファイルですが、Webサーバー経由、つまりスクリプトが実行した結果は、JavaScriptのプログラムが返されます。拡張子は.phpですが、MIMEタイプはtext/javascriptで返される、JavaScriptのプログラムであり、それがINTER-Mediatorのクライアントサイドで稼働するプログラムの本体になります。</p><p>　以上の点から、ページファイルのヘッダーからBODYタグの部分は、リスト2-2-2のような書き方が一般的な記述方法になります。もちろん、ヘッダーには他にスタイルシートの読み込みやMETAタグ、他のJavaScriptのプログラムの読み込みがあってもかまいません。定義ファイルをSCRIPTタグで読み込む部分が必須の記述になります。</p><div class="code"><div class="caption">リスト2-2-2　定義ファイルがdef01.phpの場合のページファイルの例</div><pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;INTER-Mediator Sample&lt;/title&gt;
    &lt;script type="text/javascript" src="def01.php"&gt;&lt;/script&gt;
&lt;/head&gt;
	:</code></pre></div><p>　なお、Ver.5.4-devの途中までは、INTER-Mediatorを動作させるきっかけを記述する必要がありました。「<span xmlns="" id="ix-75"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>INTERMediator.construct(true);」というJavaScriptのプログラムを記述する必要があったのです。そのために、<span xmlns="" id="ix-76"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-77"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>BODYタグのonload属性か、SCRIPTタグないしは別途拡張子が.jsのファイルを用意して、そこで<span xmlns="" id="ix-78"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>window.onloadに対して無名関数を定義するなど行っていました。Ver.5.4-devの途中より、このconstructメソッドの呼び出しは自動的に行われるようになりましたので、記述の必要は無くなりました。</p><p>　実際にデータベースのデータを表示するのは、BODYタグの内部になります。ここでは、コンテキストに「postalcode」という名前のコンテキストがあり、そこには、f3、f7、f8、f9といったフィールドがあることが既知であるとします。このとき、以下のように記述を行います。一般的なHTMLでのTABLEタグを利用したテーブルですが、一般的なページとの違いは、<span xmlns="" id="ix-79"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>data-im属性があることです。data-im属性の値は「コンテキスト名@フィールド名」と記述します。すると、最初のTDタグ要素では、postalcodeコンテキストから得られたレコードのf3フィールドの値が、TDタグ要素のテキスト要素、つまり、&lt;td&gt;と&lt;/td&gt;の間に挟み込まれるといった処理をINTER-Mediatorが行います。</p><div class="code"><div class="caption">リスト2-2-3　ページファイルのボディ部の記述例</div><pre><code>&lt;body&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;&lt;th&gt;f3&lt;/th&gt;&lt;th&gt;f8&lt;/th&gt;
    &lt;th&gt;f9&lt;/th&gt;&lt;th&gt;f10&lt;/th&gt;&lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td data-im="postalcode@f3"&gt;&lt;/td&gt;
      &lt;td data-im="postalcode@f7"&gt;&lt;/td&gt;
      &lt;td data-im="postalcode@f8"&gt;&lt;/td&gt;
      &lt;td data-im="postalcode@f9"&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;/body&gt;</code></pre></div><p>　もし、ここで、postalcodeコンテキストが<span xmlns="" id="ix-80"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-81"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>複数のレコードからなる場合はどうなるでしょうか？　INTER-Mediatorは、TBODYタグの内部のTRタグ要素を、レコードごとに用意して、追加します。つまり、この場合はTRタグ要素がひとつありますが、レコードが10個あれば、TRタグ要素は10個並び、レコードの順に前からTBODYタグ要素の子要素として追加されて行きます。このとき、繰り返されるTRタグ要素を「<span xmlns="" id="ix-82"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>リピーター」、その親要素であるTBODYタグ要素を「<span xmlns="" id="ix-83"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>エンクロージャー」と呼びます。つまり、エンクロージャーの子要素にあるリピーターが、レコードの数だけ繰り返すということをINTER-Mediatorは行います。</p><p>　表2-2-2のようないくつかのレコードがコンテキストから得られた場合、INTER-Mediatorはクライアントサイドでリスト2-2-4のようなタグ要素を生成します。その結果、テンプレートとしてのページファイルの内容にコンテキストで得られたデータを合成して、ブラウザーの画面に表示されることになります。</p><div class="table"><table><tr><th>id</th><th>f3</th><th>f7</th><th>f8</th><th>f9</th></tr><tr><td>1</td><td>1000000</td><td>東京都</td><td>千代田区</td><td>以下に掲載がない場合</td></tr><tr><td>2</td><td>1020072</td><td>東京都</td><td>千代田区</td><td>飯田橋</td></tr><tr><td>3</td><td>1020082</td><td>東京都</td><td>千代田区</td><td>一番町</td></tr><tr><td>4</td><td>1010032</td><td>東京都</td><td>千代田区</td><td>岩本町</td></tr><tr><td>5</td><td>1010047</td><td>東京都</td><td>千代田区</td><td>内神田</td></tr><tr><td>:</td><td>:</td><td>:</td><td>:</td><td>:</td></tr></table><div class="caption">表2-2-2　postalcodeコンテキストから得られたリレーションの例</div></div><div class="code"><div class="caption">リスト2-2-4　いくつかのレコードのデータを合成した結果</div><pre><code>&lt;body&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;&lt;th&gt;f3&lt;/th&gt;&lt;th&gt;f8&lt;/th&gt;
    &lt;th&gt;f9&lt;/th&gt;&lt;th&gt;f10&lt;/th&gt;&lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td data-im="postalcode@f3"&gt;1000000&lt;/td&gt;
      &lt;td data-im="postalcode@f7"&gt;東京都&lt;/td&gt;
      &lt;td data-im="postalcode@f8"&gt;千代田区&lt;/td&gt;
      &lt;td data-im="postalcode@f9"&gt;以下に掲載がない場合&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td data-im="postalcode@f3"&gt;1020072&lt;/td&gt;
      &lt;td data-im="postalcode@f7"&gt;東京都&lt;/td&gt;
      &lt;td data-im="postalcode@f8"&gt;千代田区&lt;/td&gt;
      &lt;td data-im="postalcode@f9"&gt;飯田橋&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td data-im="postalcode@f3"&gt;1020082&lt;/td&gt;
      &lt;td data-im="postalcode@f7"&gt;東京都&lt;/td&gt;
      &lt;td data-im="postalcode@f8"&gt;千代田区&lt;/td&gt;
      &lt;td data-im="postalcode@f9"&gt;一番町&lt;/td&gt;
    &lt;/tr&gt;
            :
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;/body&gt;</code></pre></div><p>　ここではTDタグにdata-im属性を記述しましたが、DIVやSPAN、Pなどの汎用的なタグにも記述できます。また、タグのテキストだけでなく、タグの属性にもフィールドのデータを差し込むことができます。ここでは、エンクロージャーとしてのTBODYとリピーターとしてのTRの組み合わせの中で、TRタグの内部にdata-im属性を持つタグ要素が存在しています。INTER-Mediatorはdata-im要素を持つタグ要素を「リンクノード」として識別し、リンクノードの上位ノードを検索して、リピーターの範囲を決めます。そして、そのリピーターの中で使われているコンテキストを求めてデータベースアクセスし、得られた結果を合成するといった動作を行います。</p><h3><span id="H3-ANC-9"><span style="display:none">→</span></span><span class="exsign">演習</span>データベースの内容をリスト表示する</h3><p>　以下、演習を通じて、データベースに入力されている郵便番号の情報を、Webページ上に一覧表示をしてみます。演習は、演習環境を利用している前提で手順を記載しますので、実際にお手元で作業を行ってみてください。</p><h4><span xmlns="" id="ix-84"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-85"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>データベースの内容を確認する（MySQL）</h4><p>　まず最初に、データベースの内容をチェックします。MySQLについては以下のようにして、コマンドラインで参照しますが、コマンドラインに慣れていない方は、画面ショットの最後の結果だけを見て、データベースの中身を確認するだけでもかまいません。</p><div class="step"><span class="stepnumber">1</span>macOSの場合は「ターミナル」アプリケーション、Windowsの場合はPowerShellなどを利用して、MySQLが稼働しているコンテナに接続します。このコンテナはホストOSから接続できるよに、13306番ポートを開けてあります。ターミナルの場合は、次のようにコマンドを入力します。ユーザ名とパスワードをコマンドラインにふくめてあります。</div><div class="code"><pre><code>mysql -u web -h 127.0.0.1 -P 13306 --password=password test_db</code></pre></div><div class="step"><span class="stepnumber">2</span>コマンドが成功すると、MySQLのプロンプトになります。例えば、以下のようなSQLコマンドを実行して、データベースの中身を見てみます。</div><div class="code"><pre><code>select * from postalcode limit 6;</code></pre></div><div class="step"><span class="stepnumber">3</span>データベースを見ると、以下のような特徴があることが分かります。</div><ul><li>データベースtest_dbに、postalcodeテーブルがある</li><li>このテーブルのフィールド構成は、f3が郵便番号、f7〜9が都道府県・市区町村・町域名となっている</li><li>フィールドidは整数値で、レコードを特定する一意な値が設定されている</li><li>フィールドmemoがあり、データは入っていない。このフィールドは文字列型である</li></ul><div class="picture"><img class="picture-small" src="figs/ng-shot-023.png"/></div><h4>データベースの内容を確認する（FileMaker）</h4><p>　FileMaker Server上のサンプルデータベース「TestDB.fmp12」を開き、「postalcode」レイアウトを参照してみます。FileMaker Proで開いて確認しておきましょう。</p><ul><li>データベースTestDBに、postalcodeテーブルおよび同名のTOCがあり、postalcodeレイアウトで表示されている</li><li>このテーブルのフィールド構成は、f3が郵便番号、f7〜9が都道府県・市区町村・町域名となっている</li><li>フィールドidは整数値で、レコードを特定する一意な値が設定されている</li><li>フィールドmemoがあり、データは入っていない。このフィールドは文字列型である</li></ul><div class="picture"><img class="picture-small" src="figs/ng-shot-024.png"/></div><h4><span xmlns="" id="ix-86"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-87"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>定義ファイルを編集する</h4><div class="step"><span class="stepnumber">1</span>ここからの作業は、Webブラウザー上で行います。ブラウザーで、「http://localhost:9080」に接続します。「トライアル用のページファイルと定義ファイル」という見出し部分を画面スクロールさせて表示してください。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-007.png"/></div><div class="step"><span class="stepnumber">2</span>「def01.phpを編集する」をクリックします。このdef01.phpというファイルは、定義ファイルです。すると、def01.phpファイルを編集する定義ファイルエディターが開きます。（本コースでは、用意されたリンクの1番目から利用しますが、もし、他の用途で1番目を利用しているのなら、例えば、def11.phpを利用するなど、別の番号のセットを使用してください。その場合ソースコードの記述が変わる部分がありますが、可能な限り注記します。）</div><div class="picture"><img class="picture-small" src="figs/ng-shot-008.png"/></div><div class="step"><span class="stepnumber">3</span>Contextsの中のQueryと書かれ背景がグレーの部分を特定します。そして、その次の行の右の方にある「削除」をクリックして、Queryの設定がある行を削除します。</div><div class="step"><span class="stepnumber">4</span>「レコードを本当に削除していいですか？」とたずねられるので、OKボタンをクリックします。</div><div class="step"><span class="stepnumber">5</span>同様に、Sortingの次の行にある「削除」ボタンを押し、確認にOKボタンをクリックして、こちらの設定も削除しておきます。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-009.png"/></div><div class="step"><span class="stepnumber">6</span>repeat-controlの右のテキストフィールドを削除して空白にします。そして、Tabキーを押して、次のフィールドに移動します。</div><div class="step-wo-number">定義ファイルエディターは、テキストフィールドを修正したとき、別のテキストフィールドに移動するときに書き戻しを行います。原則として、テキストフィールド修正後にはTabキーを押して確定することとします。</div><div class="step"><span class="stepnumber">7</span>Database Settingsに設定を行います。『2-1　データベースからの取り出し設定』で説明した設定項目に従って入力を行います。</div><div class="step-wo-number">[MySQL]の場合<br/>db-classは「PDO」のままでかまいません。dsnに「mysql:host=db;dbname=test_db;charset=utf8mb4」と入力します。そして、userに「web」、passwordに「password」と入力します。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-013.png"/></div><div class="step-wo-number">[FileMaker]の場合<br/>db-classを「FileMaker_DataAPI」に書き換えます。databaseは「TestDB」、userに「web」、passwordに「password」、serverに「gateway.docker.internal」、portに「443」、protocolに「https」、cert-vefifyingに「false」と入力します。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-025.png"/></div><div class="step-wo-number">最後にTabキーを押して、確定することを忘れないでください。</div><p>　MySQLの場合、ApacheやPHPが稼働しているコンテナから、MySQLが稼働しているコンテナへ接続が必要です。この場合、コンテナ間をつなぐ仮想ネットワーク上で利用できる名前があります。「db」は、仮想ネットワークで使えるMySQLコンテナのサーバ名です。Docker Composerの設定ファイルで定義されています。gateway.docker.internalはコンテナからホストOSを参照可能なサーバ名で、Docker自身がこの名前でのアクセスを提供しています。</p><h4><span xmlns="" id="ix-88"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-89"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ページファイルを編集する</h4><div class="step"><span class="stepnumber">1</span>「http://localhost:9080」で開いたページに戻ります。通常、定義ファイルエディターは異なるタブあるいは異なるウインドウに表示されるので、「http://localhost:9080」のページは別のタブあるいはウインドウにあるはずです。そちらに切り替えます。</div><div class="step"><span class="stepnumber">2</span>「page01.htmlを編集する」をクリックします。このpage01.htmlというファイルは、ページファイルです。すると、page01.htmlファイルを編集するページファイルエディターが開きます。（別の番号のセットで作業している場合には、該当する番号のリンクをクリックしてください。）</div><div class="picture"><img class="picture-small" src="figs/ng-shot-010.png"/></div><div class="step"><span class="stepnumber">3</span>まずは、表の基本構造を考えます。page01.htmlを以下のように変更します。単にTABLEタグで表を作り、THEAD、TBODYを明示しています。まだここではINTER-Mediatorによるデータベースアクセスは行っていません。なお、スタイルについては特に意味はありませんので、自由に設定してかまいません。</div><div class="code"><pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;table&gt;
        &lt;thead&gt;
            &lt;tr&gt;&lt;th&gt;郵便番号&lt;/th&gt;&lt;th&gt;住所&lt;/th&gt;&lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
            &lt;tr&gt;&lt;td&gt;1111111&lt;/td&gt;&lt;td&gt;東京特許許可局&lt;/td&gt;&lt;/tr&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><div class="picture"><img class="picture-small" src="figs/ng-shot-011.png"/></div><div class="step"><span class="stepnumber">4</span>「http://localhost:9080」で開いたページに戻ります。別のタブあるいはウインドウにあるはずです。そちらに切り替えます。</div><div class="step"><span class="stepnumber">5</span>「page01.htmlを表示する」をクリックします。page01.htmlファイルが別のタブあるいはウインドウで開きます。（別の番号のセットで作業している場合には、該当する番号のリンクをクリックしてください。）この段階では、単にHTMLで定義した通りに見えています。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-012.png"/></div><div class="step-wo-number">ここまでの作業で、「http://localhost:9080」で開いたページ、def01.phpの編集ページ、page01.htmlの編集ページ、page01.htmlを開いたページの4つのタブあるいはウインドウが見えていると思われます。これらのタブやウインドウは閉じないでそのままにして、必要に応じて切り替え、更新等をすることで作業を継続できますので、以後はこの4つのページを切り替えて作業します。</div><div class="step"><span class="stepnumber">6</span>「page01.htmlを編集する」で開いたページファイルエディターのページに切り替えて、HTMLのコードを以下のように修正します。追加修正する部分は太字で示しています。</div><div class="code"><pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
  &lt;title&gt;&lt;/title&gt;
  <strong>&lt;script type="text/javascript" src="def01.php"&gt;&lt;/script&gt;</strong>
&lt;/head&gt;
&lt;body&gt;
    &lt;table&gt;
        &lt;thead&gt;
            &lt;tr&gt;&lt;th&gt;郵便番号&lt;/th&gt;&lt;th&gt;住所&lt;/th&gt;&lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
            &lt;tr&gt;
              &lt;td <strong>data-im="postalcode@f3"</strong>&gt;&lt;/td&gt;
              &lt;td&gt;
                <strong>&lt;span data-im="postalcode@f7"&gt;&lt;/span&gt;</strong>
                <strong>&lt;span data-im="postalcode@f8"&gt;&lt;/span&gt;</strong>
                <strong>&lt;span data-im="postalcode@f9"&gt;&lt;/span&gt;</strong>
              &lt;/td&gt;
          &lt;/tr&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;
&lt;/body&gt;</code></pre></div><h4>データベースからの取り出し結果の表示</h4><div class="step"><span class="stepnumber">1</span>「page01.htmlを表示する」で表示したページに切り替えます。そして、画面の更新を行います。アドレスバーの左右にあるボタンなどを利用して、画面を更新します。</div><div class="step"><span class="stepnumber">2</span>次のように、グレーのボックスで何かたくさん表示されました。これは、現在デバッグモードになっており、データベースとのやりとりの部分を細かくログとして表示しています。途中を見ると、どんなSQL（あるいはRESTリクエスト）が発行されて、どんなデータが得られたかなどが分かります。消すには、ページの最初にある「clear」ボタンをクリックします。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-014.png"/></div><div class="step"><span class="stepnumber">3</span>テーブルのページが表示されました。データベースの内容が、テーブルの中に表示されていることを確認してください。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-015.png"/></div><div class="step"><span class="stepnumber">4</span>「def01.phpを編集する」によって表示された定義ファイルエディターのページを表示します。一番下のDebugの部分の「2」を「false」に書き換えて、Tabキーを押して値を確定させます。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-016.png"/></div><div class="step"><span class="stepnumber">5</span>「page01.htmlを表示する」で表示したページに切り替えます。画面の更新をします。デバッグ情報は表示されなくなり、ページの要素としての表だけが見えています。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-017.png"/></div><h4>作成したファイルの確認</h4><p>　演習環境で変更するページファイルや定義ファイルは、IMApp_Trialレポジトリの中のsrcフォルダに存在します。ページファイルの中身は、ページファイルエディター上で見えるものと同じですが、定義ファイルのそのものの内容を確認してみます。</p><div class="step"><span class="stepnumber">1</span>演習環境をセットアップしたときに用意したレポジトリのフォルダを開きます。</div><div class="step"><span class="stepnumber">2</span>レポジトリの直下のsrcフォルダにあるdef01.phpとpage01.htmlが、この演習で作成したファイルです。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-018.png"/></div><div class="code"><pre><code>&lt;?php
//todo ## Set the valid path to the file 'INTER-Mediator.php'
require_once('INTER-Mediator/INTER-Mediator.php');

IM_Entry(array (
  0 =&gt; 
  array (
    'name' =&gt; 'postalcode',
    'table' =&gt; 'postalcode',
    'view' =&gt; 'postalcode',
    'records' =&gt; 10,
    'maxrecords' =&gt; 100,
    'paging' =&gt; true,
    'key' =&gt; 'id',
  ),
),
array (
),
array (
  'db-class' =&gt; 'PDO',
  'dsn' =&gt; 'mysql:host=localhost;dbname=test_db;charset=utf8mb4',
  'user' =&gt; 'web',
  'password' =&gt; 'password',
),
false);
?&gt;</code></pre></div><p>　定義ファイルの中身と、定義ファイルエディターの設定の対比をしてみてください。連想配列のキーに相当する部分はページ上では固定された文字列となっており、値に相当する部分が入力可能なテキストフィールドになっています。ここで見えているデータベース接続に関するキーと値は『2-1　データベースからの取り出し設定』ですでに説明した通りです。コンテキストの設定については、この後に説明をします。</p><p>　なお、定義ファイルを構成する上では、「0 =&gt;」のような、数値のインデックスはあってもなくてもかまいません。手作業で定義ファイルを作成するときには省略しますが、定義ファイルエディターが機械的にファイルを生成するので、余計な記述が含まれてしまっています。</p><h4>演習のまとめ</h4><ul><li>定義ファイルとページファイルを作成することで、データベースの内容をWebページ上に表示できます。</li><li>定義ファイルは、データベース接続に関する設定や、コンテキストの定義があります。</li><li>ページファイルはWebページのテンプレートとなります。</li><li>フィールドのデータを挿入したいタグ要素に、data-im属性でコンテキスト名とフィールド名を記述します。</li><li>ヘッダー部のSCRIPTタグを利用して、定義ファイルをJavaScriptとして呼び出して、ページに組み込みます。</li><li>データベースの内容をページの中に埋め込むページ合成の処理は、ページロードしたときに自動的に行われます。</li></ul><h3><span id="H3-ANC-10"><span style="display:none">→</span></span>コンテキストの定義内容について</h3><p>　ここまでの演習で作成した定義ファイルdef01.phpのコンテキスト定義の部分を解説しましょう。まず、コンテキストの定義は、PHPではひとつの連想配列となっています。その要素として、<span xmlns="" id="ix-90"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>nameキーによる値は必ず必要です。nameキーは文字通りコンテキストの名称であり、ページファイルのリンクノードで、どのコンテキストのデータを取り出すのかを示すために利用します。nameキーの名前は、一般的にはプログラミング言語の変数命名規則に則って付けておくのが問題は少ないでしょう。一部に稼働する場合があるかもしれませんが、nameキーの値には空白文字を入れないようにしてください。</p><p>　実際に利用するデータベースは、読み出し、つまりクエリーのときには<span xmlns="" id="ix-91"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>viewキーで指定した値を利用します。つまり、viewキーには、データベースのテーブルやビューの名前を指定します。しかしながら、viewキーの値がない場合には、nameキーの値を使います。</p><p>　一方、編集やレコード作成、レコード削除といった書き込み処理の場合は、<span xmlns="" id="ix-92"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>tableキーで指定した値を利用します。こちらはテーブルを指定するのが一般的と思われます。このtableキーの値も指定がなければ、nameキーの値を利用します。</p><p>　以上のように、viewやtableキーにより、読み書き対象のデータベース側のエンティティを個別に指定はできますが、もし、postalcodeテーブルがあるとして、nameキーの値が「postalcode」で、<span xmlns="" id="ix-93"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-94"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>viewやtableキーを省略しているとしたら、postalcodeテーブルに対して読み書きを行います。これが一番シンプルな定義になります。さらにsourceキーもデータベース側のエンティティを指定するのに利用できますが、こちらはすぐ後の『データベース上での同一エンティティであることを示すsourceキー』で説明します。</p><p>　viewやtableを別に用意しているのは、同一のテーブルでも、状況により（つまり、コンテキストにより）、異なる結果を得たい場合に対応します。同じpostalcodeでも、「新宿区の郵便番号」と「足立区の郵便番号」というコンテキストを伴う利用がある場合、nameキーはそれぞれsinjuku_postalcode、adachi_postalcodeとしておき、viewはいずれも同じpostalcodeにするという使い方が考えられます。そして、次のセクションで説明する検索条件を適切に指定をしていれば、それぞれのコンテキストは名前に従った結果が得られるということになります。</p><p>　なお、FileMakerでは、viewやtableキーの値としては、<span xmlns="" id="ix-95"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>レイアウト名を指定します。<span xmlns="" id="ix-96"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>TO名（リレーションシップのタブで定義するボックスの名称）やテーブル名ではないので、注意をしてください。FileMaker ServerのXML共有およびFileMaker Data APIの制約があり、レイアウトを経由する方法でのWeb利用しかできません。</p><p>　<span xmlns="" id="ix-97"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>keyキーに対する値は、その<span xmlns="" id="ix-98"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-99"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>テーブルの主キーを指定します。複数のフィールドは指定できません。ただし、読み出しのみの場合には、この設定はなくてもかまいませんが、編集や削除の処理で、この値を利用します。また、挿入時にも挿入したレコードを特定するためにこの設定を利用します。つまり、更新処理がなければkeyキーの設定は不要ですが、更新処理が行われる場合には必須です。FileMakerの場合、「'key' =&gt; '-recid'」という指定が可能です。これは、システムが背後でレコードに自動的に割り振る通し番号を主キーとして利用する設定です。</p><p>　<span xmlns="" id="ix-100"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>recordsキーは、検索結果の中からいくつのレコードを実際に取り出すのかということを指定するものです。postalcodeテーブルには何千ものレコードがありますが、10レコードだけが表示されています。この場合、たまたま検索して得られた先頭から10レコードを取り出しています。<span xmlns="" id="ix-101"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>maxrecordsは、recordsの値を動的に変更する仕組みを使う上で、この数値以上は絶対に上回らないようにするという設定です。いずれも、省略すると、非常に大きな数字を設定します。しかしながら、何万のレコードを一度にページに表示しようとすると多大な時間がかかってしまいます。通常はなんらかの制限が必要ですので、この数値は適切な値を与えておくのが良いでしょう。</p><p>　pagingキーの値については、別のセクションで説明します。</p><h3><span id="H3-ANC-11"><span style="display:none">→</span></span>データベース上での<span xmlns="" id="ix-102"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>同一エンティティであることを示す<span xmlns="" id="ix-103"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>sourceキー</h3><p>　Ver.5.3より、コンテキスト定義に、sourceキーの指定ができます。データベース上のエンティティ名に関連するキーとしては、name、view、tableがあり、それらに加えてsourceも利用できます。データベースから読み出しを行うときには、INTER-Mediatorが背後でSQLステートメントを生成していると考えてください（FileMaker Serverは別の方法です）。その時、FROM句に指定されるビューやテーブルの名前は、viewキーがあればその値、なければnameキーの値が使われます。CREATE/UPDATE/DELETコマンドの対象は、tableキーの値で、それがなければnameキーが使わます。例えば、nameキーにテーブル名があれば、そのテーブル名を指定しての読み書きはviewとtableキーの指定はしなくてもできます。しかしながら、表示は何かのビューを使い、更新はそのビューではない特定のテーブルを指定したいような場合に対処できるように、viewとtableキーとして異なる名前を指定できます。</p><p>　しかし、これだけでは問題があります。あるテーブルのあるレコードのあるフィールドが、ページ上の複数のリンクノードに展開された場合、それが例えば両方ともテキストフィールドであるとします。この時、一方の値を変えると、フィールド更新のためのサーバー通信が行われるとともに、クライアントサイドで同一フィールドとバインドしている別のリンクノードの値を更新します。その時、何を手掛かりにして反映させるコンテキストを探しているかといえば、「viewないしはnameキーの値が同じだが異なるコンテキスト」です。例えば、住所録的なpeopleテーブルがあり、同一ページに全レコードの一覧と、その中で男性の一覧の両方があったとします。前者のコンテキストは、name=allmembers, view=people、後者のコンテキストはname=malemembers, view=peopleとして適切なqueryキーの条件を与えればいいでしょう。こうすれば、同一テーブルから異なるコンテキストを生成して、内容が異なる一覧を1ページ内で生成できます。この時、男性の一覧にあるレコードは、必ず全員のレコードの一覧にもあります。どちらもviewキーがpeopleなので、男性のレコードのひとつのフィールドを変更すると、対応する全員の一覧にあるレコードのフィールド値も更新されます。以下、この動作は「<span xmlns="" id="ix-104"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>連動」と呼びます。同一のviewキーの値を持つコンテキスト同士なので、INTER-Mediatorにとっての手がかりがあります。</p><p>　しかしながら、データベースのスキーマに置いて、peopleをもとにした<span xmlns="" id="ix-105"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ビューeveryoneとsomeoneが定義してあったとします。それらで表を作るとしたら、nameやviewを使うにしても、everyoneとsomeoneという名前がそれぞれのコンテキスト定義に登場はしますが、コンテキスト定義から各々が同一のpeopleテーブルから導出されていることは分かりません。そうなると、同一のレコードがそれぞれの一覧に見えていて、一方の値を変更したとしても、その変更結果を伝達する手がかりがなく、連動はできません。</p><p>　このような時にはそれぞれのコンテキスト定義にsourceキーの値を指定して、一方のコンテキストを、name=everyone, source=people、もう一方はname=someone, source=peopleと定義します。ページファイル側は、everyoneあるいはsomeoneをdata-im属性に利用する点は変わりありません。このsourceの設定により、2つのコンテキスト定義から得られるコンテキストは、同一のテーブルから来ていることがINTER-Mediatorに伝わるので、それぞれのリンクノードに見えているフィールド値がユーザーインターフェース上で連動できようになります。</p><h3><span id="H3-ANC-12"><span style="display:none">→</span></span>このセクションのまとめ</h3><p>　INTER-Mediatorを使ったWebページ構築の基本である、定義ファイルとページファイルを作成することを説明しました。定義ファイルはPHPのプログラムですが、キーと値を与えるデータのセットであり、定義ファイルエディターを利用すればプログラミング言語に従った記述はしなくてもかまいません。定義ファイルの大きな目的は、コンテキストの定義とデータベースへの接続の定義です。コンテキストという中間的な存在を定義して、その内容をページファイルに埋め込みます。ページファイルでは、data-im属性により、コンテキスト名とフィールド名を指定して、フィールドのデータの埋め込みを行います。他に、定義ファイルのSCRIPTタグによる読み込みと、INTER-Mediatorを稼働するきっかけの1行のプログラムの記述が必要です。テーブルの中にdata-im属性を持つリンクノードを定義すれば、レコードの数だけTRタグ要素を複製するため、複数のレコードをページ上に展開する動作も行われます。コンテキストの定義では、name、table、viewという3つのエンティティを指定するキーがあり、同一のテーブルに対して異なる名前のコンテキストを定義して、ページファイル側で使い分けることもできます。recordsキーの値により、レコード数を制限できます。</p><!-- ============ SECTION START ============ --><h2><span id="H2-ANC-3"><span style="display:none">→</span></span><span class="sectionnumber">2-3</span>JavaScriptプログラムの記述</h2><p class="section-lead">INTER-Mediatorは定義ファイルとページファイルの記述で多くのことができますが、一部の機能やあるいは複雑な処理を構築したいような場合には、JavaScriptによるプログラムが必要になることがあります。ここでは、ページファイルや別のファイルに記述するJavaScriptのプログラムについて基本的なことと、本コースでこの後に出てくるJavaScriptによる機能の呼び出しのための基本的なことを記述します。なお、言語についての説明は本コースでは行いません。</p><h3><span id="H3-ANC-13"><span style="display:none">→</span></span>JavaScriptについての知識の確認</h3><p>　すでに<span xmlns="" id="ix-106"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>JavaScriptについての知識がある方や、これから勉強する方もいらっしゃると思います。INTER-Mediatorで使用するJavaScriptのプログラムを記述するために、どのような知識が必要なのかをまとめておきました。</p><ul><li>変数や制御構造といった言語の基本の知識はもちろん必要です。特に、配列とオブジェクトについては、読み解いたり記述ができるようになっておいてください。</li><li>JavaScriptでのオブジェクト指向プログラミングの手法は、既存のオブジェクトの利用ができる程度に習熟しておいてください。プロパティの利用はもちろん、メソッドの置き換えや追加を「変数.メソッド名 = function (parameters) {...}」といった記法で行えることなどを知っておきましょう。</li><li>HTMLの要素に対する処理は、DOM（Document Object Model）を基本としています。ただし、INTER-MediatorではDOM処理のための汎用的な仕組みもあるので、ある程度概念として知っておけばよく、DOMを駆使するほどのプログラミングは必要とはしていません。また、原則として既存のタグ要素をオブジェクトとして参照することがほとんどです。少なくともdocument.getElementById(id属性値)で、特定の要素を参照できることは知っておきましょう。</li><li>AJAXに関連する処理は、アプリケーション開発で直接記述することは、INTER-Mediatorを使う範囲ではありません。APIを用意しています。</li></ul><h3><span id="H3-ANC-14"><span style="display:none">→</span></span>INTER-Mediatorが定義する変数</h3><p>　INTER-MediatorのAPIについては、本コースで少しずつ説明しますが、表2-3-1のようなグローバル変数がすでに定義された状態になります。ほとんどは、グローバル変数であり、変数が参照するのはオブジェクトです。IMLibContextのみ、クラスとして定義されておりその実態は関数で、実際に利用するときにはそのときに定義した異なる変数名になります。また、INTER-Mediator自体ではそのほかにも変数は定義していますが、APIとして利用するグローバル変数を表にまとめました。</p><div class="table"><table><tr><th>グローバル変数名</th><th>用途</th></tr><tr><td><span xmlns="" id="ix-107"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>INTERMediator</td><td>一番中心になるオブジェクト。ページ合成を行う</td></tr><tr><td><span xmlns="" id="ix-108"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>INTERMediatorLib</td><td>機能を構築する際のサポートを行うような小規模の機能をまとめたオブジェクト</td></tr><tr><td><span xmlns="" id="ix-109"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>INTERMediatorOnPage</td><td>認証などHTMLページに連動するような機能のクラスで、メソッドの拡張もここで行うものが多い</td></tr><tr><td><span xmlns="" id="ix-110"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>INTERMediator_DBAdapter</td><td>データベースサーバーに対してのやりとりを行うオブジェクト</td></tr><tr><td><span xmlns="" id="ix-111"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IMLibUI</td><td>レコード追加などのユーザーインターフェースから利用できる機能をまとめたオブジェクト</td></tr><tr><td><span xmlns="" id="ix-112"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IMLibContext（クラス）</td><td>データベースから取り出した結果を保持するモデルに相当するオブジェクト</td></tr><tr><td><span xmlns="" id="ix-113"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IMLibContextPool</td><td>IMLibContextクラスの集合を管理するオブジェクト。APIはこちらのオブジェクトに定義</td></tr><tr><td><span xmlns="" id="ix-114"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IMLibLocalContext</td><td>データベースと独立した、クライアントだけに存在するコンテキスト</td></tr><tr><td><span xmlns="" id="ix-115"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IMParts_Catalog</td><td>JavaScriptのコンポーネントを利用するときに使用するオブジェクト</td></tr></table><div class="caption">表2-3-1　INTER-Mediatorで定義される主要な変数</div></div><p>　なお、これらの変数がいつ定義されるかというと、定義ファイルをSCRIPTタグで読み込むときです。定義ファイルはPHPのプログラムとして記述しますが、INTER-Mediatorはその定義ファイルのプログラムを実行することにより、JavaScriptのプログラムを生成してクライアントに伝達します。したがって、拡張子は.phpだけれども、ブラウザーにとってはMIMEタイプがtext/javascriptとなっているJavaScriptのプログラムがサーバーから返ってきたように見えるので、そこで実行が開始されて、これらの変数が定義されます。</p><h3><span id="H3-ANC-15"><span style="display:none">→</span></span>JavaScriptを記述する3つの代表的な場所</h3><p>　JavaScriptのプログラムを記述するには、①タグ要素の特定の属性内、②ページファイルのヘッダー、③別ファイルの3つの方法があります。タグ要素の属性内においては、何行にも渡るようなプログラムを記述するのはかえって見づらくなります。通常はひとつあるいは数個の処理ステップで終わらせるような作り方をします。</p><p>　リスト2-3-1のように、ページファイル（HTMLファイル）のヘッダー部分に、SCRIPTタグでJavaScriptのプログラムを記述することができます。HTMLのコードがダウンロードされて、解析される段階で、SCRIPTタグの内容が実行されると考えれば良いでしょう。したがって、ここでのプログラムを実行する段階では、まだ、ページの要素がロードされた状態にはなっていません。そこで、ロードされたときに実行される関数を定義したり、関数の定義があるのが一般的です。</p><div class="code"><div class="caption">リスト2-3-1　ヘッダーに記述するJavaScriptプログラム</div><pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
  &lt;title&gt;&lt;/title&gt;
  &lt;script type="text/javascript" src="def01.php"&gt;&lt;/script&gt;
  &lt;script type="text/javascript"&gt;
  INTERMediatorOnPage.doBeforeConstruct = function () {
    var params = INTERMediatorOnPage.getURLParametersAsArray();
    INTERMediator.clearCondition("postalcode");
    if (params["q"]) {
      INTERMediator.addCondition("postalcode",
         {field: "f3", operator: "LIKE", value: params["q"]});
    }
  }
  &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
         :
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><p>　ヘッダー部のSCRIPTタグで記述するJavaScriptのプログラムは、リスト2-3-2のように、別のファイル（page01.js）に記述することもできます。これにより、HTMLとJavaScriptという2つの言語が混在することはなくなり、ファイルはひとつ増えるものの、別々に管理ができます。JavaScriptのプログラムが長くなると、別々のファイルになっている方が、それぞれのファイルの内容を把握しやすくなるでしょう。JavaScriptのプログラムを記述するファイルは拡張子が.jsのファイルで、JavaScripitのプログラムそのものを記述します。すると、それを呼び出しているSCRIPTタグが解析された段階で、ファイルに記述したプログラムが実行されると考えてください。jsファイルのエンコードは、ページファイルのエンコードと同一にするのが基本です。なお、閉じタグの「&lt;/script&gt;」を記述する必要があり、「&lt;script type="text/javascript" src="page01.js" /&gt;」といった空要素による表現は行いません。空要素にすると、Internet ExplorerやFirefoxで、SCRIPTタグの内容が無視されていたため、空要素にしない記述にしています。HTMLの定義では、内容を持つタグで内容が何もない場合は空要素の記述にはしないとされており、バグというわけではありません。空要素にしても稼働するブラウザーが、拡大解釈していると考えるべきです。</p><div class="code"><div class="caption">リスト2-3-2　別のファイルに記述するJavaScriptのプログラム</div><pre><code>============================ page01.html
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
  &lt;title&gt;&lt;/title&gt;
  &lt;script type="text/javascript" src="def01.php"&gt;&lt;/script&gt;
  &lt;script type="text/javascript" src="page01.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
         :
&lt;/body&gt;
&lt;/html&gt;
============================ page01.js
INTERMediatorOnPage.doBeforeConstruct = function () {
  var params = INTERMediatorOnPage.getURLParametersAsArray();
  INTERMediator.clearCondition("postalcode");
  if (params["q"]) {
    INTERMediator.addCondition("postalcode",
       {field: "f3", operator: "LIKE", value: params["q"]});
  }
}</code></pre></div><h3><span id="H3-ANC-16"><span style="display:none">→</span></span>このセクションのまとめ</h3><p>　このセクションでは、知っておきたい範囲のJavaScriptのプログラムの知識と、INTER-Mediatorで定義されているグローバル変数、そして、プログラムを具体的にどこに記述するのかといったことを説明しました。</p><!-- ============ SECTION START ============ --><h2><span id="H2-ANC-4"><span style="display:none">→</span></span><span class="sectionnumber">2-4</span>レコードを移動するナビゲーション</h2><p class="section-lead">たくさんのレコードを決められた数だけのレコードを表示して、表示範囲を切り替えるような機能はWebサイトではよく見られるものです。こうした機能は「ページネーション」と呼ばれます。この機能もINTER-Mediatorではプログラミングの必要はありません。あるid属性を持ったノードが、ページネーションのためのナビゲーションにかわります。しかしながら、そのままだと見栄えがよくありませんので、CSSの設定も必要です。</p><h3><span id="H3-ANC-17"><span style="display:none">→</span></span><span xmlns="" id="ix-116"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-117"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ページネーションの生成</h3><p>　ページネーションのユーザーインターフェースをページ内に表示させるには、定義ファイルのコンテキストの定義中で、<span xmlns="" id="ix-118"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>pagingキーによる値をtrueにします。そのpagingキーがtrueになっているコンテキストの表示範囲をページネーションコントローラーで管理をします。このpagingキーは、複数のコンテキストを定義した場合、その中のひとつのコンテキストだけに指定する必要があります。複数のコンテキストでpagingキーの値がtrueの場合、どのコンテキストに適用されるかは定かではありません。</p><p>　定義ファイル側でpagingキーの設定を行った上で、ページファイルの中に、<span xmlns="" id="ix-119"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>id属性が「<span xmlns="" id="ix-120"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IM_NAVIGATOR」のタグ要素を追加します。要素の種類はなんでもかまいませんが、帯状のコントロールを表示したいのであれば、DIVタグを使うのが便利でしょう。id属性がIM_NAVIGATORのタグ要素の子要素として、ページを前後するボタン等が追加されます。複数のページネーションを設定したい場合には、class属性がIM_NAVIGATORのタグ要素を定義します。例えば、ページトップとボトムにそれぞれページネーションが欲しいような場合にはその方法が使えます。複数のページネーションは同一の機能となります。</p><p>　以上の動作を演習で追っていきます。</p><h3><span id="H3-ANC-18"><span style="display:none">→</span></span><span class="exsign">演習</span>ページネーションのナビゲーションを表示する</h3><p>　この章で作成している定義ファイルdef01.phpとページファイルpage01.htmlに対してそのまま編集を続けます。定義ファイルにはpostalcodeというコンテキストひとつだけ定義されていて、pagingキーの値がtrueになっていました。その状態から、ページファイルを変更して、ページネーションが表示されるようにします。</p><h4>ページファイルの変更</h4><div class="step"><span class="stepnumber">1</span>Webブラウザーで「http://localhost:9080」を開きます。すでに開いている場合には、そのタブを確認します。</div><div class="step"><span class="stepnumber">2</span>「def01.phpを編集する」「page01.htmlを編集する」「page01.htmlを表示する」のリンクをクリックして、それぞれのタブを開きます。もし、すでに開いている場合には、そのタブを確認します。</div><div class="step"><span class="stepnumber">3</span>「page01.htmlを編集する」をクリックして開いたタブあるいはウインドウをで、HTMLの編集を行います。以下のように、BODYタグの後に、DIVタグを追加します。</div><div class="code"><pre><code>&lt;body&gt;
  <strong>&lt;div id="IM_NAVIGATOR"&gt;&lt;/div&gt;</strong>
    &lt;table&gt;</code></pre></div><div class="step"><span class="stepnumber">4</span>「page01.htmlを表示する」をクリックして表示したタブあるいはウインドウで、画面の更新を行います。すると、テーブルの上部に現在表示中のレコード番号、ページ指定のボックスなどが表示されました。テーブルの上部のグレーの帯の部分が、ページネーションのコントローラーです。全部で3654のレコードがあり、その中の1〜10レコード目のデータが現在表示していることを示します。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-026.png"/></div><div class="step"><span class="stepnumber">5</span>「&gt;」ボタnは、次のページを表示することを示しています。クリックすると、11〜20レコード目、21〜30レコード目、31〜40レコード目と、10レコードずつ先を表示するようになります。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-027.png"/></div><div class="step"><span class="stepnumber">6</span>「&gt;&gt;」ボタンは、最後のページを表示することを示しています。クリックすると、3651〜3654レコード目、つまり、一連のレコードの最後のレコードを含む一群が表示されています。最後なので10レコードとは限らず、ここでは4レコードが表示されています。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-028.png"/></div><h4>演習のまとめ</h4><ul><li>id属性がIM_NAVIGATORとなっている要素が、INTER-Mediatorによりページネーションのコントロールになります。</li><li>ページネーションのコントロールに必要なスタイルは、テーマの中に設定されているので、通常はそのまま表示されます。</li><li>定義ファイルのコンテキスト定義で、pagingキーの値がtrueのコンテキストに対して、一定数ずつのレコードを表示します。</li><li>1ページ内のレコード数は、コンテキスト定義のrecordsキーの値で指定ができます。</li></ul><h3><span id="H3-ANC-19"><span style="display:none">→</span></span><span xmlns="" id="ix-121"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-122"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ページネーションのカスタマイズ</h3><p>　ページネーションのコントロールのボタンは、SPANタグで表現していますが、例えば、クリック可能なボタンは、class属性がIM_NAV_infoに指定されています。このように、要素に対するクラス設定が自動的になされているので、対応するセレクタに対するスタイルを記述することで、ある程度のカスタマイズは可能です。表2-4-1に、あらかじめ設定されているクラスをまとめておきます。なお、#IM_NAVIGATORについては、当初からつけられたid属性に対応するもので、このセレクタも利用できます。なお、ページネーションのスタイルはテーマの機能と連動しています。具体的なカスタマイズ方法は、『5-6　スタイルの設定を自動化するテーマ』でも説明します。</p><div class="table"><table><tr><th>スタイルシートのセレクタ</th><th>ページネーションの該当部分</th></tr><tr><td>#IM_NAVIGATOR</td><td>コントローラーの外側</td></tr><tr><td>.<span xmlns="" id="ix-123"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IM_NAV_panel</td><td>コントローラー全体</td></tr><tr><td>span.<span xmlns="" id="ix-124"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IM_NAV_info</td><td>文字を表示する部分</td></tr><tr><td>span.<span xmlns="" id="ix-125"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IM_NAV_button</td><td>ボタンになる部分（機能するボタン）</td></tr><tr><td>span.I<span xmlns="" id="ix-126"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>M_NAV_disabled</td><td>機能しないボタンの部分</td></tr></table><div class="caption">表2-4-1　ページネーションで割り当てられたスタイルシートのセレクタ</div></div><p>　さらにページネーションの中の文言についてもカスタマイズが可能ですが、JavaScriptでのプログラミングが必要になります。JavaScriptのプログラミングについては、『Chapter 6　JavaScriptでのプログラミング』で説明をしますが、ここではその内容を踏まえて結果のみ記載しておきます。</p><p>　具体的には、<span xmlns="" id="ix-127"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>INTERMediator.<span xmlns="" id="ix-128"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>navigationLabelに配列を設定することで、ページネーションの各要素に対するカスタマイズが可能です。配列のインデックスと対応する箇所は表2-4-2に示します。INTERMediator.navigationLabelに何も設定しない場合には、表の既定値が画面に見えます。なお、インデックス9のレコード追加などのボタンについては、コンテキスト定義でのbutton-namesキーでの指定で、既定値ではない名前を設定できます（『3-3　レコードの追加・削除・複製』の『挿入と削除のコントロール』を参照）。</p><div class="table"><table><tr><th>インデックス</th><th>設定対象</th><th>既定値</th><th>非表示</th></tr><tr><td>0</td><td>最初のレコードに戻る</td><td>&lt;&lt;</td><td>インデックス0〜3</td></tr><tr><td>1</td><td>前のページに戻る</td><td>&lt;</td><td>無関係</td></tr><tr><td>2</td><td>次のページに進む</td><td>&gt;</td><td>無関係</td></tr><tr><td>3</td><td>最後のレコードに進む</td><td>&gt;&gt;</td><td>無関係</td></tr><tr><td>4</td><td>レコード番号の直前</td><td>レコード番号</td><td>インデックス4〜7</td></tr><tr><td>5</td><td>レコード番号の範囲の間の文字列</td><td>-</td><td>無関係</td></tr><tr><td>6</td><td>レコード番号範囲と全レコード数の間の文字列</td><td>/</td><td>無関係</td></tr><tr><td>7</td><td>全レコード数の後の文字列</td><td>（空文字列）</td><td>無関係</td></tr><tr><td>8</td><td>更新ボタンの名称</td><td>更新</td><td>インデックス8</td></tr><tr><td>9</td><td>レコード作成などのボタン</td><td>作成や削除などレコード操作のボタン</td><td>インデックス9</td></tr><tr><td>10</td><td>まとめ保存のボタン</td><td>保存</td><td>インデックス10</td></tr><tr><td>11</td><td>ログアウトボタンの名称</td><td>ログアウト</td><td>インデックス11</td></tr></table><div class="caption">表2-4-2　JavaScriptによる要素のカスタマイズ</div></div><p>　INTERMediator.navigationLabelへの配列の設定は、ページ合成よりも前である必要があるので、INTERMediatorOnPage.doBeforeConstructに代入する関数内部で記述します。記述方法の例としては、例えばリスト2-4-1のような形式になります。INTERMediator.navigationLabelの右辺に要素が12ある配列を記述しますが、最後のnullが続く部分は省略してもかまいません。それぞれの要素が、表2-4-2のインデックスに対応します。要素がnullだと既定値のままになります。要素に文字列を指定すると、その文字列に置き換わります。インデックスが0、4、8、9、10、11についてはfalseを指定することで、ページネーションの中の要素を表示しなくなります。リスト2-4-1ではインデックスが8のものがfalseになっているので、「更新」ボタンが非表示になり、他の要素はそのまま表示します。</p><div class="code"><div class="caption">リスト2-4-1　ページネーションのカスタマイズを行うページファイルの例</div><pre><code>&lt;head&gt;
&lt;script type="text/javascript"&gt;
INTERMediatorOnPage.doBeforeConstruct = function () {
	INTERMediator.navigationLabel = [null, null, null, null, null, null, null, null, false];
}
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/body&gt;</code></pre></div><p>　例えば、INTERMediator.navigationLabel = ["最初", "前", "次", "最後"] のように指定すると、&lt;&lt;ボタンは「最初」ボタンなどと変更されます。INTERMediator.navigationLabel = [false, null, null, null, null, null, null, null, null] だと、インデックスの0〜3のものが非表示となり、ページを前後するボタンが画面には出てこなくなります。</p><h3><span id="H3-ANC-20"><span style="display:none">→</span></span>このセクションのまとめ</h3><p>　ページネーションは、pagingキーの値をtrueにしたひとつのコンテキストに対して構築され、機能します。また、そのコンテキスト定義のrecordsキーの値に応じて、1ページあたりのレコード数が決まります。ページファイルでは、id属性にIM_NAVIGATORを指定したDIVタグ要素などを配置しておけば、その場所にページネーションのコントロールが構築されます。スタイルシートによって、コントロール内部の要素のカスタマイズができますが、ボタン名などはJavaScriptを利用してカスタマイズが可能です。</p><!-- ============ SECTION START ============ --><h2><span id="H2-ANC-5"><span style="display:none">→</span></span><span class="sectionnumber">2-5</span>検索と並べ替えに関する設定</h2><p class="section-lead">実際の業務において、データベースの内容を単に表示するだけで事足りる事例はほとんどありません。通常はさまざまな<span xmlns="" id="ix-129"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>検索条件や<span xmlns="" id="ix-130"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>並べ替えの条件を指定したりします。こうした設定はINTER-Mediatorでは、定義ファイル上に設定することができます。ここでは固定的な条件を定義ファイル上に記述する方法を紹介しましょう。実行時に条件が決まるような場合には、JavaScriptから設定を行います。</p><h3><span id="H3-ANC-21"><span style="display:none">→</span></span>定義ファイルへの条件設定</h3><p>　データベースへのクエリーを行うとき、SQLではWHERE句やORDER BY句で、検索条件やソート対象フィールドを指定します。INTER-Mediatorでは、その設定を行う場所として、まず、コンテキスト中を利用できます。リスト2-5-1はひとつのコンテキスト定義だけを抜き出した設定例です。PHPでの記述がファイルに対してそのまま記述されたものですが、実際の設定は定義ファイルエディターで可能ですので、設定時のキー名とその値を記述する後半の記述で理解しても良いでしょう。<span xmlns="" id="ix-131"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>queryおよび<span xmlns="" id="ix-132"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>sortキーに対する値を設定しますが、設定項目が複数あり、その項目がさらに複数あるので、「連想配列の配列」で記述します。後半の記述では、ひとつの塊を示すために、[ ] で囲みます。</p><div class="code"><div class="caption">リスト2-5-1　定義ファイルでの検索条件とソート対象フィールドの指定</div><pre><code>（PHPでの記述）array(
	'name' =&gt; 'postalcode',
	'query' =&gt; array ( 
		array ( 'field'=&gt;'f3', 'operator'=&gt;'like', 'value'=&gt;'16%' ),
		array ( 'field'=&gt;'f8', 'operator'=&gt;'=', 'value'=&gt;'新宿区' )
	),
	'sort' =&gt; array ( 
		array ( 'field'=&gt;'f3', 'direction'=&gt;'desc' )
	)
)

（項目のみに注目した記述）
name：postalcode
query：
	[field：f3、operator：like、value：16%]
	[field：f8、operator：=、value：新宿区]
sort：
	[field：f3、direction：desc]</code></pre></div><p>　sortキーの配列は、<span xmlns="" id="ix-133"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>field、<span xmlns="" id="ix-134"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>directionの2つのキーを持ちます。リスト2-5-1ではひとつの連想配列だけでしたが、複数の連想配列を記述した場合、順番に、並べ替えのキーとして利用します。fieldの指定は必ず必要ですが、directionは省略すると昇順と解釈します。<span xmlns="" id="ix-135"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ascが<span xmlns="" id="ix-136"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>昇順、<span xmlns="" id="ix-137"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>descが<span xmlns="" id="ix-138"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>昇順で、サポートするすべてのデータベースはこの書き方で問題ありません（FileMakerでは置き換えを内部で行います）。</p><p>　queryキーの配列の中は、<span xmlns="" id="ix-139"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>field、<span xmlns="" id="ix-140"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>operator、<span xmlns="" id="ix-141"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>valueの3つのキーを持ちます。それぞれ文字通り、コンテキストの元になるテーブルやビューにあるフィールド名と、検索条件に含める演算子、そして値を指定します。リスト2-5-1の最初の連想配列の場合は、MySQL向けであり、「`f3` like '16%'」というSQLステートメントの断片が記述されます。フィールド名や、値は、実際にデータベースアクセスする前にエスケープ処理を行っているので、この段階での記述ではエスケープ処理の必要はありません。</p><p>　演算子および値については、データベースエンジンに依存します。例えばMySQLの場合、[field：f3、operator：like、value：16%] により、「16で始まるf3フィールドのデータのあるレコード」が検索されます。<span xmlns="" id="ix-142"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>%という記述や<span xmlns="" id="ix-143"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>like演算子は、MySQLに準拠したものです。したがって、queryキーの記述は、データベースごとによる違いがどうしても発生します。MySQLは多数の演算子をサポートしていますが、FileMakerで使用できるものとの対応は表2-5-1の通りです。MySQLの列のlike演算子は、likeと値に%を含む記述を行うことを意味しており、_は何らかの文字列に置き換わります。同等な条件をFileMaker Server向けに作成するには、[field：f3、operator：bw、value：16] となります。なお、「<span xmlns="" id="ix-144"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IS NULL」および「<span xmlns="" id="ix-145"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>IS NOT NULL」については、operatorにこの記述を行い、valueには何も書かないでおきます。なお、cnやbwといった演算子は、XML共有やPHP共有で使われていたものです。FileMaker Data APIへの対応時に、過去との互換性を確保するために、db-classがFileMaker_FXの場合と同じ検索条件が使えるようにしたため、XML共有特有の演算子が利用できます。しかしながら、FileMaker Data API特有の演算子も利用できます。</p><div class="table"><table><tr><th>MySQL</th><th>FileMaker_FX</th><th>条件判断</th></tr><tr><td><span xmlns="" id="ix-146"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>=</td><td>eq</td><td>等しい</td></tr><tr><td>like '%_%'</td><td><span xmlns="" id="ix-147"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>cn</td><td>含む</td></tr><tr><td>like '_%'</td><td><span xmlns="" id="ix-148"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>bw</td><td>データで始まる</td></tr><tr><td>like '%_'</td><td><span xmlns="" id="ix-149"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ew</td><td>データで終わる</td></tr><tr><td><span xmlns="" id="ix-150"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>&gt;</td><td><span xmlns="" id="ix-151"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>gt</td><td>より大きい</td></tr><tr><td><span xmlns="" id="ix-152"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>&gt;=</td><td><span xmlns="" id="ix-153"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>gte</td><td>より大きいか等しい</td></tr><tr><td><span xmlns="" id="ix-154"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>&lt;</td><td><span xmlns="" id="ix-155"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>lt</td><td>より小さい</td></tr><tr><td><span xmlns="" id="ix-156"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>&lt;=</td><td><span xmlns="" id="ix-157"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>lte</td><td>より小さいか等しい</td></tr><tr><td><span xmlns="" id="ix-158"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>!=</td><td><span xmlns="" id="ix-159"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>neq</td><td>等しくない</td></tr></table><div class="caption">表2-5-1　operatorに使える演算子をMySQLとFileMakerで比較</div></div><p>　値については、ワイルドカードに対する文字列がデータベースに依存することが注意点です。また、<span xmlns="" id="ix-160"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-161"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>FileMakerの場合で、完全一致にするには、operatorをeqにして、値は「=値」の形式にする必要があります。また、FileMakerで、「フィールド=値1<span xmlns="" id="ix-162"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>...値2」の形式で検索条件を与えるには、operatorを<span xmlns="" id="ix-163"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>asis、値を「値1...値2」と指定してください。</p><p>　日付データについては、データベースエンジンの記述法に従ってください。MySQLなどのSQLデータベースでは「2015-05-25 12:00:00」のような年月日の順に-で結ぶSQLでのルールに従います。FileMakerの場合は、月/日/年の記述つまり「5/25/2015 12:00:00」という記述を行います。</p><p>　queryの配列が複数ある場合、単に並べて記述されていれば、それらは、ANDで結ばれます。つまり、リスト2-5-1のような条件がある場合には、「`f3` like '16%' and `f8` = '新宿区'」となり、「f3フィールドが16で始まり、かつ、f8フィールドが新宿区」のレコードが抽出されます。</p><p>　もし、<span xmlns="" id="ix-164"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>OR条件で記述したい場合は、次のように記述します。2番目の配列により、「ANDとORを入れ替えるという考え方」を適用しています。<span xmlns="" id="ix-165"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>__operation__も<span xmlns="" id="ix-166"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>exも決められたキーワードで、その通りの文字列で記述します。以下の場合、「`f3` like '16%' or `f8` = '新宿区'」という条件が生成されます。なお、FileMakerの場合は検索条件に式を記述することができないので、__operation__を記述すると、「すべての演算子がORとなる」という動作になります。FileMakerの場合は「ex」あるいは「or」というキーワードが使えます。FileMakerでORを導入するときは、デバッグモードでどんな検索がされているかを確認しながら設定を行うことをお勧めします。</p><div class="code"><div class="caption">リスト2-5-2　検索条件でOR演算を行う場合</div><pre><code>query：
	[field：f3、operator：like、value：16%]
	[field：__operation__、operator：ex]
	[field：f8、operator：=、value：新宿区]</code></pre></div><p>　さらに複雑な条件を設定した例はリスト2-5-3の通りです。fieldが<span xmlns="" id="ix-167"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>__operation__の場合は、そこまででいったん式をまとめるという意味合いがあります。通常は、andでまとめた式をorでつなげますが、operatorがexの場合は、orでまとめた式をandでつなげるという逆動作になります。なお、複雑な式の記述はここまでです。理論的には、すべての論理式が<span xmlns="" id="ix-168"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>論理和標準形ないしは<span xmlns="" id="ix-169"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>論理積標準形で表現できるという定理があるので、この仕様ですべての論理式が記述できると言えるかと思われます。しかしながら、さまざまなロジックが絡む判定がアプリケーションにはつきものです。INTER-Mediatorではこの条件設定以外にもさまざまな手法がありますが、場合によっては、データベースが持つ機能、例えば、ビューを作ったり、ストアドプロシージャを使ったり、FileMaker Serverの場合はスクリプトの呼び出しを行うなどを利用することで、より適切な解決策になることも考えられます。</p><div class="code"><div class="caption">リスト2-5-3　複雑な条件の指定</div><pre><code>query：
	[field：age、operator：&gt;、value：19]
	[field：year、operator：&gt;、value：1980]
	[field：__operation__]
	[field：age、operator：&lt;、value：39]
	[field：year、operator：&lt;、value：2006]
生成される条件：(age &gt; '19' and year &gt; '1980') or (age &lt; '39' and year &lt; '2006')

query：
	[field：age、operator：&gt;、value：19]
	[field：year、operator：&gt;、value：1980]
	[field：__operation__、operator：ex]
	[field：age、operator：&lt;、value：39]
	[field：year、operator：&lt;、value：2006]
生成される条件：(age &gt; '19' or year &gt; '1980') and (age &lt; '39' or year &lt; '2006')</code></pre></div><p>　定義ファイルをPHPのコードとして記述するとき、queryキー内の配列のvalueキーに表2-5-2のようなキーワードを利用することができます。定義ファイルエディターでは、IM_TODAYなどと記述すると、その文字列そのものになりますので、この記述は定義ファイルを別のテキストエディターで開くなど、PHPのコードとして直接編集する場合にだけご利用ください。</p><div class="table"><table><tr><th>キーワード</th><th>置き換わる値</th></tr><tr><td>IM_TODAY</td><td>今日現在の日付</td></tr><tr><td>IM_NOW</td><td>いま現在の日時</td></tr></table><div class="caption">表2-5-2　valueキーに指定できるキーワード</div></div><h3><span id="H3-ANC-22"><span style="display:none">→</span></span>JavaScriptで<span xmlns="" id="ix-170"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-171"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>検索条件を付加する方法</h3><p>　コンテキストに記述した検索条件やソート条件は、そのコンテキストに対して常に適用される条件になります。これに対して、アプリケーション稼働時に決まるような検索条件を、JavaScriptで付与する手法も用意されています。JavaScriptを利用する方法を使うと、コンテキストの条件に、さらにプログラムで条件をプラスすることができます。例えば、来週締め切りを迎えるプロジェクトを表示させるといったことが可能になります。</p><p>　具体的には、条件を付与して、ページの合成を行うのが基本です。リスト2-5-4はその例です。diaryというコンテキストへのクエリーを行うときに、「`theDate` &lt;= '2015-01-01'」という検索条件を付与します。コンテキストで決定される条件全体に対して、and条件で、JavaScriptで指定した条件が追加されます。addConditionメソッドは2つの引数を取り、最初がコンテキスト名、次が条件です。条件は、これまで通りfield、operator、valueというプロパティに対する値を指定したオブジェクトです。</p><div class="code"><div class="caption">リスト2-5-4　JavaScriptで検索条件を付与した例</div><pre><code>&lt;script type="text/javascript"&gt;
INTERMediatorOnPage.doBeforeConstruct = function () {
	INTERMediator.<span xmlns="" id="ix-172"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>addCondition("diary", {field: "theDate", operator: "&lt;=", value: "2015-01-01"});
	INTERMediator.<span xmlns="" id="ix-173"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>addSortKey("diary", {field: "theDate", direction: "asc"});
}
&lt;/script&gt;</code></pre></div><p>　現在設定されている検索条件を得るには、INTERMediator.<span xmlns="" id="ix-174"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>additionalConditionを利用します。addtionalConditonプロパティに配列が入っています。例えば、リスト2-5-5の実行により、INTERMediator.additionalCondition["diary"]の値が「{field: "theDate", operator: "&lt;=", value: "2015-01-01"}」となります。このプロパティはオブジェクトに保持されるので、明示的に消すまで消えません。したがって、条件が変わるような場合、「INTERMediator.additionalCondition = [];」によって一度クリアする必要がある場合も出てくると考えられます。</p><p>　並べ替え条件の付与は、同様にINTERMediator.addSortKeyメソッドを利用します。また、参照は、INTERMediator.<span xmlns="" id="ix-175"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>additionalSortKeyプロパティを利用します。</p><h3><span id="H3-ANC-23"><span style="display:none">→</span></span><span class="exsign">演習</span>データベース検索に条件を追加する</h3><p>　この演習では、コンテキストに検索条件やソート対象フィールドの設定を付与して、その条件が適用されて検索されていることを確認します。</p><h4>コンテキストに検索条件を追加する</h4><div class="step"><span class="stepnumber">1</span>Webブラウザーで「http://localhost:9080」を開きます。すでに開いている場合には、そのタブを確認します。</div><div class="step"><span class="stepnumber">2</span>「def01.phpを編集する」「page01.htmlを編集する」「page01.htmlを表示する」のリンクをクリックして、それぞれのタブを開きます。もし、すでに開いている場合には、そのタブを確認します。</div><div class="step"><span class="stepnumber">3</span>「def01.phpを編集する」をクリックして表示されるタブあるいはウインドウを表示します。ここで、Contextsに、nameがpostalcodeの定義が設定されているのを確認し、Queryの下の「追加」ボタンをクリックします。追加していいかどうかをダイアログボックスでたずねるので、OKボタンをクリックします。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-030.png"/></div><div class="step"><span class="stepnumber">4</span>Queryの下に新たな設定項目が追加されました。最初は適当なデータが入っています。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-031.png"/></div><div class="step"><span class="stepnumber">5</span>新たに作成されたQueryの次の行の部分で、fieldには「f8」、operatorには「=」、valueには「豊島区」をキータイプします。最後のテキストフィールドにキータイプした後、Tabキーを押して、設定内容を確定しておきます。（FileMakerでも=の指定は可能です）</div><div class="picture"><img class="picture-small" src="figs/ng-shot-032.png"/></div><div class="step"><span class="stepnumber">6</span>「page01.htmlを表示する」をクリックして表示されるタブあるいはウインドウを表示します。今までは千代田区などのデータが見えていましたが、豊島区だけのデータになりました。また、レコード数もぐっと減って83レコードとなっています。コンテキストに指定した検索条件、つまりf8フィールドが豊島区のものだけに絞られていることが確認できました。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-033.png"/></div><div class="step"><span class="stepnumber">7</span>「def01.phpを編集する」をクリックして表示されるタブあるいはウインドウを表示します。Queryの次の行の検索条件を変更します。最後のテキストフィールドにキータイプした後、Tabキーを押して、設定内容を確定しておきます。</div><div class="step-wo-number">MySQLの場合は、fieldには「f3」、operatorには「like」、valueには「16%」をキータイプします。</div><div class="step-wo-number">FileMakerの場合には、fieldには「f3」、operatorには「bw」、valueには「16」をキータイプします。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-034.png"/></div><div class="step"><span class="stepnumber">8</span>「page01.htmlを表示する」をクリックして表示されるタブあるいはウインドウを表示します。検索条件通り、f3フィールドが「16」で始まるものだけのデータになりました。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-035.png"/></div><h4>コンテキストにソート対象フィールドを追加する</h4><div class="step"><span class="stepnumber">1</span>「def01.phpを編集する」をクリックして表示されるタブあるいはウインドウを表示します。ここで、Contextsに、nameがpostalcodeの定義が設定されているのを確認し、Sortingの下の「追加」ボタンをクリックします。追加していいかどうかをダイアログボックスでたずねるので、OKボタンをクリックします。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-036.png"/></div><div class="step"><span class="stepnumber">2</span>Sortingの下に新たな設定項目が追加されました。最初は適当なデータが入っています。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-037.png"/></div><div class="step"><span class="stepnumber">3</span>新たに作成されたSortingの次の行の部分で、fieldには「f3」、directionには「desc」をキータイプします。最後のテキストフィールドにキータイプした後、Tabキーを押して、設定内容を確定しておきます。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-038.png"/></div><div class="step"><span class="stepnumber">4</span>「page01.htmlを表示する」をクリックして表示されるタブあるいはウインドウを表示します。検索条件通り、f3フィールドが「16」で始まるものだけのデータに絞られていますが、加えて、f3フィールドのデータの逆順に並べ替えられています。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-039.png"/></div><h4>演習のまとめ</h4><ul><li>コンテキストには検索条件をqueryキーで付与できます。</li><li>検索条件は、フィールド、演算子、値を与えることで定義できます。</li><li>コンテキストにはソート対象フィールドをsortキーで付与できます。</li><li>フィールド名と、昇順か降順かを与えて定義します。</li></ul><h3><span id="H3-ANC-24"><span style="display:none">→</span></span>ユーザーインターフェースの定義だけで検索条件を付与する</h3><p>　データベースの内容を一覧するときに、検索結果を適用するという仕組みを一切プログラムを書かずに実現するために、ボタンやテキストフィールド、あるいは一般的なノードに対して機能を割り当てるという機能があります。要素の<span xmlns="" id="ix-176"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>data-im属性を利用して、<span xmlns="" id="ix-177"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>ローカルコンテキスト（クライアントサイドでデータを記録する一種の「モデル」で、名前は「<span xmlns="" id="ix-178"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>_」）に特別なキー名でバインドすることで、機能が割り当てられます。以下は具体例でその機能を説明します。</p><h4>検索条件を付与するテキストフィールド</h4><p>　クエリー時に検索条件を付加するための記法の例がリスト2-5-5です。検索条件は通常、テキストフィールドにキータイプして、returnキーを押して検索されることを期待します。そこで、リスト2-5-5のようなdata-im属性を持ったINPUTタグ要素を記述します。この要素は、コンテキストの外に記述します。中に記述すると、繰り返されてしまうので、外側に記述するのが一般的と思われます。data-im属性の@以前は、ローカルコンテキストを示す_を指定します。@以降は、コロン（:）で4つのセクションに分かれます。それぞれのセクションに記入する内容は、表2-5-3にまとめました。</p><div class="code"><div class="caption">リスト2-5-5　検索条件のテキストフィールドの記述例</div><pre><code>&lt;input type="text" data-im="_@condition:postalcode:f3,f7,f8,f9:*match*"&gt;</code></pre></div><div class="table"><table><tr><th>セクション</th><th>例</th><th>記述内容</th></tr><tr><td class="nowrap">第1セクション</td><td class="nowrap"><span xmlns="" id="ix-179"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>condition</td><td>この文字列「condition」と記述する</td></tr><tr><td class="nowrap">第2セクション</td><td class="nowrap">postalcode</td><td>コンテキスト名</td></tr><tr><td class="nowrap">第3セクション</td><td class="nowrap">f3,f7,f8,f9</td><td>フィールド名。カンマ区切りで複数の指定も可能で、その場合はOR条件。FileMakerのフィールド名に含まれる「::」は、「;;」に置き換えて指定</td></tr><tr><td class="nowrap">第4セクション</td><td class="nowrap"><span xmlns="" id="ix-180"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>*match*</td><td>演算子（記述可能な演算子：= != &lt; &gt; &lt;= &gt;= <span xmlns="" id="ix-181"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>*match <span xmlns="" id="ix-182"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>match* *match*）</td></tr></table><div class="caption">表2-5-3　検索条件のテキストフィールドに指定する内容</div></div><p>　最初の2つのセクションは、説明通りです。3つ目のセクションのフィールド指定はカンマで区切って複数指定も可能です。複数指定をすると、それぞれのフィールドに対して同じ値の検索条件をORで与えます。演算子は、データベースエンジンに関わらずに、表に示した演算子を記述します。matchを含む演算子は、*の位置に応じて、順に<span xmlns="" id="ix-183"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>後方一致（*match）、<span xmlns="" id="ix-184"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>前方一致（match*）、<span xmlns="" id="ix-185"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>部分一致（*match*）に対応します。</p><p>　リスト2-5-5で示したテキストフィールドに、例えば「新宿」と入れてEnterキーを押すと、例えばMySQLを使っている場合には「f3 LIKE '%新宿%' OR f7 LIKE '%新宿%' OR f8 LIKE '%新宿%' OR f9 LIKE '%新宿%'」検索条件がコンテキストに付加されて、再度検索を行い、そのコンテキストのエンクロージャー内が更新され、検索結果が表示されます。</p><p>　テキストフィールドが空白のときには、""やNULLでの条件を設定するわけではなく、このテキストフィールドによる検索条件自体の設定が行われません。</p><p>　同様なテキストフィールドを2つ以上配置すると、それぞれのテキストフィールドで決まる検索条件に対して、andでの検索が行われます。また、このとき、テキストフィールドが空白だった場合、そのテキストフィールドに対する検索条件は、やはり設定されません。</p><p>　2つのテキストフィールドをorで結びたい場合や、あるいは空白時に特別な処理をしたいような場合には、単にテキストフィールドを配置した上で、その値を取り出し、addConditionメソッドを使うなどするJavaScriptのプログラムを実行して、検索処理を実施するようにします。</p><h4><span xmlns="" id="ix-186"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-187"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>表示件数を指定するポップアップメニュー</h4><p>　リスト2-5-6のポップアップメニューを選択すると、レコードの表示件数をポップアップの選択肢で指定でき、選択と同時にコンテキストが更新されます。data-im属性に指定する「<span xmlns="" id="ix-188"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>limitnumber」が決められた名前で、コロンより後にはコンテキスト名を記述します。そして、選択肢のためにOPTIONタグ要素を並べますが、選択した項目のvalue属性の値が、表示件数となります。このポップアップメニューのchangeイベントにより、コンテキストを更新します。</p><div class="code"><div class="caption">リスト2-5-6　ページあたりの表示件数を選択するポップアップメニュー</div><pre><code>&lt;select type="text" data-im="_@limitnumber:postalcode"&gt;
	&lt;option value="5"&gt;5件ずつ&lt;/option&gt;
	&lt;option value="10"&gt;10件ずつ&lt;/option&gt;
	&lt;option value="30"&gt;30件ずつ&lt;/option&gt;
&lt;/select&gt;</code></pre></div><h4><span xmlns="" id="ix-189"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-190"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>コンテキストの更新ボタン（検索ボタン）</h4><p>　リスト2-5-7のボタンをクリックすると、指定したコンテキストが更新されます。つまり、「検索」ボタンとして機能するということです。「<span xmlns="" id="ix-191"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>update」が決められた名前で、コロンより後にはコンテキスト名を記述します。clickイベントにより、コンテキストの更新します。</p><div class="code"><div class="caption">リスト2-5-7　コンテキストの更新ボタン</div><pre><code>&lt;button data-im="_@update:postalcode"&gt;検索ボタン&lt;/button&gt;</code></pre></div><h4><span xmlns="" id="ix-192"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-193"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>並べ替えフィールドの指定</h4><p>　リスト2-5-8のSPANタグ内の▲をクリックすると、f3フィールドの昇順で並べ替えを行います。記述するタグはSPANに限らず、onclick属性が適用できるのであれば、なんでもかまいません。clickイベントにより指定したコンテキストが更新されます。</p><p>　@以降は、コロン（:）で4つのセクションに分かれます。それぞれのセクションに記述する内容は、表2-5-4に記載します。ここで、同一のコンテキストに対する「addorder」の機能を持った要素は連動します。例えば「f3で昇順」の後に「f9の降順」を選択すると、「f9の降順」を最優先とし、続くキーとして「f3で昇順」を設定します。最後に設定した条件が最優先になるようになっています。</p><div class="code"><div class="caption">リスト2-5-8　フィールドの並べ替えを指定</div><pre><code>&lt;span style="cursor: pointer" data-im="_@addorder:postalcode:f3:asc"&gt;▲&lt;/span&gt;</code></pre></div><div class="table"><table><tr><th>セクション</th><th>例</th><th>記述内容</th></tr><tr><td>第1セクション</td><td><span xmlns="" id="ix-194"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>addorder</td><td>この文字列「addorder」を記述する</td></tr><tr><td>第2セクション</td><td>postalcode</td><td>コンテキスト名</td></tr><tr><td>第3セクション</td><td>f3</td><td>フィールド名。ひとつのみ</td></tr><tr><td>第4セクション</td><td>asc</td><td>昇順ならasc、降順ならdesc</td></tr></table><div class="caption">表2-5-4　並べ替えるタグ要素に指定する内容</div></div><h3><span id="H3-ANC-25"><span style="display:none">→</span></span><span class="exsign">演習</span>検索のユーザーインターフェースを作成する</h3><p>　この演習では、検索条件やソート対象フィールドのユーザーインターフェースをページファイル上に定義して、そのユーザーインターフェースが期待通りの動作をすることを確認します。</p><h4>検索条件を与えるテキストフィールド</h4><div class="step"><span class="stepnumber">1</span>Webブラウザーで「http://localhost:9080」を開きます。すでに開いている場合には、そのタブを確認します。</div><div class="step"><span class="stepnumber">2</span>「def01.phpを編集する」「page01.htmlを編集する」「page01.htmlを表示する」のリンクをクリックして、それぞれのタブを開きます。もし、すでに開いている場合には、そのタブを確認します。</div><div class="step"><span class="stepnumber">3</span>「def01.phpを編集する」をクリックして表示されるタブあるいはウインドウを表示します。Queryの次の行の検索条件の右側にある「削除」ボタンをクリックします。また、Sortingの次の行にある「削除」ボタンをクリックします。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-040.png"/></div><div class="step"><span class="stepnumber">4</span>QueryおよびSortingの次の行に項目がなにもない状態になっていることを確認します。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-041.png"/></div><div class="step"><span class="stepnumber">5</span>「page01.htmlを編集する」をクリックして表示されるタブあるいはウインドウを表示します。BODYタグの次の行に、検索のためのユーザーインターフェースに関する記述を追加します。</div><div class="code"><pre><code>&lt;body&gt;
  <strong>検索：&lt;input type="text" data-im="_@condition:postalcode:f8,f9:*match*"/&gt;</strong>
  &lt;div id="IM_NAVIGATOR"&gt;&lt;/div&gt;
    &lt;table&gt;</code></pre></div><div class="picture"><img class="picture-small" src="figs/ng-shot-042.png"/></div><div class="step"><span class="stepnumber">6</span>「page01.htmlを表示する」をクリックして表示されるタブあるいはウインドウを表示します。レコードの個数が3654なので、すべてのデータが見えています。ここで、ページの冒頭に「検索」と書かれたテキストフィールドがあることを確認します。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-043.png"/></div><div class="step"><span class="stepnumber">7</span>検索のテキストフィールドに「青」と入力して、Enterキーを押します。すると、全レコード数が55になり、検索された一覧を見ると、f8ないしはf9に、「青」という文字が含まれた住所のみが検索されていることが分かります。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-044.png"/></div><div class="step"><span class="stepnumber">8</span>検索のテキストフィールドに「赤」と入力して、Enterキーを押します。同様に、f8ないしはf9に、「赤」という文字が含まれた住所のみが検索されていることが分かります。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-045.png"/></div><h4>その他の検索用ユーザーインターフェース要素</h4><div class="step"><span class="stepnumber">1</span>「page01.htmlを編集する」をクリックして表示されるタブあるいはウインドウを表示します。ページネーションのDIVタグ要素の前に、以下のように追加します。また、テーブルのヘッダー部分も追加します。</div><div class="code"><pre><code>&lt;body&gt;
  検索：&lt;input type="text" data-im="_@condition:postalcode:f8,f9:*match*"/&gt;
  <strong>&lt;button data-im="_@update:postalcode"&gt;検索&lt;/button&gt;</strong>
  <strong>レコード数：&lt;select data-im="_@limitnumber:postalcode"&gt;</strong>
  <strong>&lt;option value="5"&gt;5&lt;/option&gt;</strong>
  <strong>&lt;option value="10" selected="selected"&gt;10&lt;/option&gt;</strong>
  <strong>&lt;option value="20"&gt;20&lt;/option&gt;</strong>
  <strong>&lt;/select&gt;</strong>
  &lt;div id="IM_NAVIGATOR"&gt;&lt;/div&gt;
    &lt;table&gt;
        &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;
                郵便番号
                <strong>&lt;span style="cursor: pointer" data-im="_@addorder:postalcode:f3:asc"&gt;▲&lt;/span&gt;</strong>
                <strong>&lt;span style="cursor: pointer" data-im="_@addorder:postalcode:f3:desc"&gt;▼&lt;/span&gt;</strong>
              &lt;/th&gt;
              &lt;th&gt;住所&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;</code></pre></div><div class="step"><span class="stepnumber">2</span>「page01.htmlを表示する」をクリックして表示されるタブあるいはウインドウを表示します。「検索」ボタンをクリックすれば、検索が行われることを確認します。そして、ポップアップメニューから「20」を選択します。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-046.png"/></div><div class="step"><span class="stepnumber">3</span>1ページあたり20レコードになりました。以後、20ページ表示の状態が保持されます。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-047.png"/></div><div class="step"><span class="stepnumber">4</span>「郵便番号」の右の「▼」をクリックすると、郵便番号の降順（大きいものが最初に来る）での並べ替えが行われました。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-048.png"/></div><div class="step"><span class="stepnumber">5</span>「郵便番号」の右の「▲」をクリックすると、郵便番号の昇順（小さいものが最初に来る）での並べ替えが行われました。</div><div class="picture"><img class="picture-small" src="figs/ng-shot-049.png"/></div><h4>演習のまとめ</h4><ul><li>検索条件を与えるテキストフィールドを、ページファイルへの設定のみで用意できます。</li><li>同様に、検索ボタン、1ページの件数、並べ替え指定の要素も、ページファイルへの設定のみで用意できます。</li></ul><h3><span id="H3-ANC-26"><span style="display:none">→</span></span><span xmlns="" id="ix-195"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span><span xmlns="" id="ix-196"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>SQLの集計処理</h3><p>　INTER-Mediatorはコンテキスト定義やあるいは動作上の状況から自動的にSQLステートメントを生成します。通常のリレーション取得はそれでもいいのですが、SUM関数などを使う集計処理（アグリゲーション）を行うようなSQLを生成させたいことがあるでしょう。集計処理を伴うビューを利用してその結果から検索をして必要な集計結果を取り出すこともできますが、その方法では集計として不要なレコードの処理も行うことになるかもしれません。そこで、コンテキスト定義やあるいはその他の検索条件の指定も含めたSQLコマンドの記述ができるようになっています。</p><p>　SQLコマンドの記述ができるように、コンテキスト定義に<span xmlns="" id="ix-197"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>aggregation-select、<span xmlns="" id="ix-198"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>aggregation-from、<span xmlns="" id="ix-199"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>aggregation-group-byという3つのキーが記述できます。これらのキーがあると、viewキーはSQL生成では無視されます。また、読み込み処理のみをサポートし、更新等の処理は行えないコンテキストとなるので、tableキー、keyキーは実質的に使われません。aggregation-select、aggregation-fromは両方とも指定する必要があります。これらのキーを設定すると、コンテキストからの読み込みに次のようなSQLを生成します。つまりaggregation-で始まるキーに加えて、query、relation、sort、recordsキーの値や、JavaScriptで動的に追加した検索条件などが加味されたSQLのSELECTステートメントが生成されてデータベースに送られます。</p><div class="code"><div class="caption">リスト2-5-9　生成されるSQLステートメント</div><pre><code>SELECT [aggregation-selectの値]
FROM [aggregation-fromの値]
WHERE [query, relation, その他による検索条件]
ORDER BY [sort, その他によるソート条件]
GROUP BY [aggregation-group-byの値]
LIMIT [recordsの値]
START [オフセット値]</code></pre></div><p>　なお、STARTについては、引き渡しは実装しましたが、Ver.5.3現在、0でのみ利用してください。つまり、ページネーションは利用できないということです。パフォーマンスを考慮して、レコード数のカウントは、SQLの結果の数と同じにしてあるので、結果的に1ページ分しか出てこないでしょう。これは、後々改良をすることとします。また、このコンテキストは、PDOでしか利用できず、FileMaker Serverでは利用できません。</p><p>　この機能によるパフォーマンス向上の効果を説明しましょう。例えば、大量の売り上げデータがあって、月ごとに集計したいとします。集計する方法は、SQLだけでなく、計算プロパティを使う方法ありますが、大量なので、処理を効率的にしたいため、データベース側で集計したいとします。aggregation-*キーがない場合には、月ごとの売り上げ集計結果が1レコードとなるようなビューを作成しておき、検索条件（例えば、年と月を指定）をビューに適用することになります。しかし、そのような動作だと、一旦ビューを構築するために全部のデータの集計を行うこともあり、一部のデータだけを使うという動作にならず、十分なパフォーマンスが得られません。しかし、aggregation-selectに「<span xmlns="" id="ix-200"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>SUM(price)」のような記述が含まれていれば、WHERE句で対象月に絞り込んでクエリーを実施した上で集計されるので、全部のデータを取り出して処理をするということはなく、より最適化されたSQLが発行されます。</p><p>　FROMを独立して指定できるようにしているので、ここに、「テーブル名 <span xmlns="" id="ix-201"><xhtml:span xmlns:xhtml="http://www.w3.org/1999/xhtml" style="display:none;">→</xhtml:span></span>JOIN テーブル名 ON 条件」という記述によるテーブル結合もできます。aggregation-*キーはそのまま指定されるようになっていて、とりあえず、現状ではフィールド名のクォートなどはしていません。セキュリティ的に問題になる可能性もありますが、クライアントのユーザーによって改変できない内容なので、構築時に注意をしておけば基本的には問題ないでしょう。</p><h3><span id="H3-ANC-27"><span style="display:none">→</span></span>このセクションのまとめ</h3><p>　データベースへのクエリーでは、検索条件やソート対象フィールドの指定が欠かせません。INTER-Mediatorでは、コンテキストへの設定、およびJavaScriptでの動的な設定をサポートします。加えて、ユーザーインターフェース要素へのルールに従った記述により、例えばテキストフィールドを配置するだけで検索条件を設定する機能を追加することもできます。</p></div></body></html>
